<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة إدارة الأعمال</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .module-container, #login-screen, #main-menu-screen { display: none; } /* مخفي بشكل افتراضي */
        .page { display: none; } /* الصفحات مخفية بشكل افتراضي */
        .page.active { display: block; } /* الصفحة النشطة تظهر */
        .layout-view { display: none; } /* عروض التخطيط مخفية بشكل افتراضي */
        .layout-view.active { display: block; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #14b8a6; color: white; }
        .sidebar-link svg { margin-left: 0.75rem; }
        /* تم إضافة تأثيرات الـ hover للبطاقات الجديدة */
        .module-card, .zone-card, .column-card { transition: transform 0.2s, box-shadow 0.2s; }
        .module-card:hover, .zone-card:hover, .column-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        /* نمط خاص لبطاقات التقارير لجعلها أكثر تناسقًا مع البطاقات الأخرى */
        .report-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .report-card-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 4rem;
            height: 4rem;
            border-radius: 9999px; /* For full circle */
            margin-bottom: 0.75rem;
        }
        .shelf-column-container { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
        .shelf-column { display: flex; flex-direction: column; gap: 0.5rem; }
        .shelf { width: 5rem; height: 3rem; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; }
        .shelf.available { background-color: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .shelf.available:hover { background-color: #a7f3d0; }
        .shelf.occupied { background-color: #fee2e2; border: 1px solid #ef4444; color: #991b1b; font-weight: bold; }
        .shelf-tooltip { position: absolute; background-color: #1f2937; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; z-index: 50; display: none; white-space: nowrap; max-width: 300px; }
        @media print {
            body * { visibility: hidden; }
            #printable-invoice, #printable-invoice * { visibility: visible; }
            #printable-invoice {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                direction: rtl;
                font-family: 'Cairo', sans-serif;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- شاشة تسجيل الدخول -->
    <div id="login-screen" class="flex flex-col items-center justify-center p-8 min-h-screen">
        <div class="text-center bg-white p-12 rounded-2xl shadow-xl max-w-lg w-full">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-700 mb-4">منصة إدارة الأعمال</h1>
            <p class="text-slate-600 mb-8">يرجى تسجيل الدخول للوصول إلى أنظمة العمل المتكاملة.</p>

            <!-- نموذج تسجيل الدخول بالبريد الإلكتروني وكلمة المرور -->
            <form id="email-password-form" class="space-y-4 mb-6">
                <div>
                    <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
                </div>
                <div>
                    <input type="password" id="login-password" placeholder="كلمة المرور" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
                </div>
                <button type="submit" id="email-login-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors shadow-sm">
                    تسجيل الدخول
                </button>
                <button type="button" id="email-signup-button" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-3 px-6 rounded-lg transition-colors shadow-sm">
                    إنشاء حساب جديد
                </button>
            </form>

            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-slate-300"></div>
                <span class="flex-shrink mx-4 text-slate-400">أو</span>
                <div class="flex-grow border-t border-slate-300"></div>
            </div>

            <!-- زر تسجيل الدخول باستخدام جوجل -->
            <button id="google-login-button" onclick="signInWithGoogle()" class="flex items-center justify-center w-full bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 font-semibold py-3 px-6 rounded-lg transition-colors shadow-sm">
                <svg class="w-6 h-6 ml-3" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                تسجيل الدخول باستخدام جوجل
            </button>
        </div>
    </div>

    <!-- شاشة اختيار الأنظمة الرئيسية -->
    <div id="main-menu-screen" class="min-h-screen p-8">
        <header class="flex justify-between items-center mb-12">
            <h1 class="text-3xl font-bold text-slate-800">القائمة الرئيسية</h1>
            <div id="main-menu-user-info" class="flex items-center">
                <span id="main-menu-user-display-name" class="font-semibold ml-4 text-slate-600"></span>
                <button onclick="signOutUser()" class="text-sm text-red-600 hover:underline mr-2">تسجيل الخروج</button>
            </div>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div onclick="showModule('inventory-module-container')" class="module-card bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer"><div class="bg-teal-100 text-teal-600 rounded-full h-20 w-20 flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></div><h3 class="text-2xl font-bold text-slate-800">نظام المخازن</h3><p class="text-slate-500 mt-2">إدارة الأصناف والعملاء والمخزون.</p></div>
            <div onclick="showModule('invoicing-module-container')" class="module-card bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer"><div class="bg-sky-100 text-sky-600 rounded-full h-20 w-20 flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div><h3 class="text-2xl font-bold text-slate-800">نظام الفوترة</h3><p class="text-slate-500 mt-2">إصدار الفواتير وعروض الأسعار.</p></div>
            <div onclick="showModule('financial-module-container')" class="module-card bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer"><div class="bg-amber-100 text-amber-600 rounded-full h-20 w-20 flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg></div><h3 class="text-2xl font-bold text-slate-800">النظام المالي</h3><p class="text-slate-500 mt-2">إدارة المصروفات، الإيرادات والتقارير.</p></div>
            <div onclick="showModule('hr-module-container')" class="module-card bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer"><div class="bg-violet-100 text-violet-600 rounded-full h-20 w-20 flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div><h3 class="text-2xl font-bold text-slate-800">شؤون الموظفين</h3><p class="text-slate-500 mt-2">الرواتب، الإجازات، ونهاية الخدمة.</p></div>
        </div>
    </div>
    
    <!-- MODULE: Inventory System -->
    <div id="inventory-module-container" class="module-container flex min-h-screen w-full">
        <aside class="w-64 bg-white shadow-lg flex flex-col p-4">
            <h2 class="text-xl font-bold text-teal-700 text-center mb-4 mt-4">نظام المخازن</h2>
            <button onclick="showModule('main-menu-screen')" class="mb-4 text-sm text-blue-600 hover:underline"> &larr; العودة للقائمة الرئيسية</button>
            <nav class="flex-grow space-y-2">
                <a href="#" onclick="showPage('page-layout', 'inventory-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5v4m5 5h-4" /></svg><span>مخطط المستودع</span></a>
                <a href="#" onclick="showPage('page-dashboard', 'inventory-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span>الإحصائيات</span></a>
                <a href="#" onclick="showPage('page-customers', 'inventory-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span>العملاء</span></a>
                <a href="#" onclick="showPage('page-inventory', 'inventory-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg><span>جدول المخزون</span></a>
                <a href="#" onclick="showPage('page-transactions', 'inventory-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.356-2a8.001 8.001 0 0115.356-2m0 0H15" /></svg><span>الحركات المخزنية</span></a>
                <a href="#" onclick="showPage('page-reports', 'inventory-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>التقارير</span></a>
                <a href="#" onclick="showPage('page-settings', 'inventory-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>إعدادات المستودع</span></a>
            </nav>
        </aside>
        <div class="flex-grow p-4 md:p-8 bg-slate-100">
            <!-- PAGE: Layout -->
            <main id="page-layout" class="page active">
                <div id="layout-header" class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <!-- This will be populated by JS -->
                </div>
                <div id="layout-views-container">
                    <div id="layout-zones-view" class="layout-view active"></div>
                    <div id="layout-zone-detail-view" class="layout-view"></div>
                </div>
            </main>
            <!-- Other pages for inventory module... -->
            <main id="page-dashboard" class="page"><h2 class="text-3xl font-bold text-slate-800">لوحة التحكم الرئيسية</h2><div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse"><div class="bg-teal-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg></div><div><h3 class="text-slate-500">إجمالي الشركات</h3><p id="total-companies" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse"><div class="bg-sky-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div><div><h3 class="text-slate-500">إجمالي عدد المنتجات</h3><p id="total-items" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse"><div class="bg-amber-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8h6m-5 4h.01M4.878 21.121A10.002 10.002 0 0012 23a10.002 10.002 0 007.122-2.879M15 4.878A10.002 10.002 0 0012 2 10.002 10.002 0 004.878 4.878" /></svg></div><div><h3 class="text-slate-500">القيمة الإجمالية للمخزون</h3><p id="total-value" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse"><div class="bg-rose-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-rose-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div><div><h3 class="text-slate-500">المواقع المحجوزة اليوم</h3><p id="today-items" class="text-2xl font-bold">0</p></div></div></div><div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold text-teal-700 mb-4">قيمة المخزون حسب الشركة</h3><div class="chart-container"><canvas id="company-value-chart"></canvas></div></div></main>
            <main id="page-customers" class="page"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">إدارة العملاء</h2><button onclick="openModal('addCompanyModal')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إضافة عميل جديد</button></div><div class="bg-white p-6 rounded-xl shadow-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th scope="col" class="px-6 py-3">اسم العميل</th><th scope="col" class="px-6 py-3">المسؤول</th><th scope="col" class="px-6 py-3">العنوان</th><th scope="col" class="px-6 py-3">رقم الاتصال</th><th scope="col" class="px-6 py-3">عدد المواقع</th><th scope="col" class="px-6 py-3">إجمالي المنتجات</th><th scope="col" class="px-6 py-3 text-center">إجراءات</th></tr></thead><tbody id="customers-table-body"></tbody></table></div></div></main>
            <main id="page-inventory" class="page"><div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"><h2 class="text-3xl font-bold text-slate-800">جدول المخزون</h2><div class="flex-grow flex justify-center"><input type="text" id="search-input" placeholder="ابحث عن صنف أو شركة..." class="w-full max-w-lg p-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"></div><div class="flex gap-2"><button onclick="openModal('addItemModal')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">إضافة صنف</button><button onclick="openModal('importModal')" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">استيراد من ملف</button></div></div><div class="bg-white p-6 rounded-xl shadow-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th scope="col" class="px-6 py-3">الموقع</th><th scope="col" class="px-6 py-3">SKU</th><th scope="col" class="px-6 py-3">الصنف</th><th scope="col" class="px-6 py-3">الشركة</th><th scope="col" class="px-6 py-3">العدد</th><th scope="col" class="px-6 py-3">سعر الوحدة</th><th scope="col" class="px-6 py-3">تاريخ الإدخال</th><th scope="col" class="px-6 py-3 text-center">إجراءات</th></tr></thead><tbody id="inventory-table-body"></tbody></table></div></div></main>
            <main id="page-transactions" class="page"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">سجل الحركات المخزنية</h2><div class="flex gap-2"><button onclick="openModal('addTransactionModal')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">إضافة جديدة</button><button onclick="openModal('dispatchTransactionModal')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">صرف جديد</button></div></div><div class="bg-white p-6 rounded-xl shadow-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th class="px-4 py-2">التاريخ</th><th class="px-4 py-2">نوع الحركة</th><th class="px-4 py-2">السبب</th><th class="px-4 py-2">SKU</th><th class="px-4 py-2">الصنف</th><th class="px-4 py-2">الكمية</th></tr></thead><tbody id="transactions-table-body"></tbody></table></div></div></main>
            
            <!-- PAGE: Reports (REVISED with Monthly Rate) -->
            <main id="page-reports" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">التقارير</h2>
            
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Box 1: Storage Cost Calculator -->
                    <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h3 class="text-xl font-bold text-teal-700 mb-4">1. حساب تكاليف التخزين (فاتورة تقديرية)</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="billing-company" class="block mb-2 text-sm font-medium text-slate-900">اختر شركة:</label>
                                <select id="billing-company" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2.5"></select>
                            </div>
                            <div>
                                <label for="billing-start-date" class="block mb-2 text-sm font-medium text-slate-900">فترة الفاتورة:</label>
                                <div class="flex items-center gap-2">
                                    <input type="date" id="billing-start-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2" title="تاريخ البدء">
                                    <span class="text-slate-500">إلى</span>
                                    <input type="date" id="billing-end-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2" title="تاريخ الانتهاء">
                                </div>
                            </div>
                            <div>
                                <label for="storage-rate" class="block mb-2 text-sm font-medium text-slate-900">سعر تخزين الموقع (ر.س / للشهر):</label>
                                <input type="number" id="storage-rate" value="45" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2.5" placeholder="مثال: 45">
                            </div>
                            <button onclick="calculateBilling()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">إصدار فاتورة تقديرية</button>
                        </div>
                    </div>
            
                    <!-- Box 2: Other Reports - تم التعديل هنا لإضافة أيقونات وبطاقات للتقارير -->
                    <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                        <h3 class="text-xl font-bold text-teal-700 mb-6">2. تقارير المخزون والحركات</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- بطاقة تقرير المخزون الحالي -->
                            <div onclick="generateInventoryReport()" class="report-card bg-slate-50 hover:bg-slate-100 cursor-pointer">
                                <div class="report-card-icon bg-sky-100 text-sky-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <h4 class="text-lg font-bold text-slate-800">تقرير المخزون الحالي</h4>
                                <p class="text-slate-500 text-sm mt-1">عرض تفاصيل الأصناف المتوفرة.</p>
                            </div>

                            <!-- بطاقة تقرير حركات المخزون -->
                            <div class="report-card bg-slate-50 hover:bg-slate-100 transition-all">
                                <div class="report-card-icon bg-sky-100 text-sky-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.356-2a8.001 8.001 0 0115.356-2m0 0H15" />
                                    </svg>
                                </div>
                                <h4 class="text-lg font-bold text-slate-800">تقرير حركات المخزون</h4>
                                <p class="text-slate-500 text-sm mt-1 mb-3">سجل الإضافات والصرف لفترة محددة.</p>
                                <div class="space-y-2 w-full">
                                    <div class="flex items-center gap-2">
                                        <input type="date" id="report-start-date" class="bg-slate-100 border border-slate-300 text-sm rounded-lg block w-full p-2" title="تاريخ البدء">
                                        <span class="text-slate-500">إلى</span>
                                        <input type="date" id="report-end-date" class="bg-slate-100 border border-slate-300 text-sm rounded-lg block w-full p-2" title="تاريخ الانتهاء">
                                    </div>
                                    <button onclick="generateTransactionsReport()" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors mt-2">إنشاء التقرير</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Area for showing billing result -->
                <div id="billing-result" class="mt-8 hidden bg-white p-6 rounded-xl shadow-lg">
                    <div id="invoice-header" class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">تفاصيل الفاتورة لـ <span id="billing-result-company" class="text-teal-600"></span></h3>
                        <button onclick="printInvoice()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                            طباعة
                        </button>
                    </div>
                    <div id="billing-details" class="mt-2 max-h-60 overflow-y-auto p-2 border rounded-md bg-slate-50"></div>
                    <div class="mt-4 pt-4 border-t-2 border-teal-500 font-bold text-xl flex justify-between">
                        <span>الإجمالي التقديري:</span>
                        <span id="billing-total" class="text-teal-700"></span>
                    </div>
                </div>

                <!-- Area for showing other reports -->
                <div id="report-display" class="mt-8 hidden bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 id="report-display-title" class="text-xl font-bold text-slate-800"></h3>
                        <div>
                            <button onclick="printGeneratedReport()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-1 px-3 rounded-lg text-sm ml-2">طباعة</button>
                            <button onclick="document.getElementById('report-display').classList.add('hidden')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm">إغلاق</button>
                        </div>
                    </div>
                    <div id="report-display-content" class="max-h-[60vh] overflow-y-auto">
                        <!-- Report table will be injected here -->
                    </div>
                </div>
            </main>

            <main id="page-settings" class="page"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">إعدادات المستودع</h2><button onclick="openModal('addZoneModal')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إضافة منطقة جديدة</button></div><div id="warehouse-settings-container" class="bg-white p-6 rounded-xl shadow-lg"></div></main>
        </div>
    </div>
    
    <!-- MODULE: Financial System -->
    <div id="financial-module-container" class="module-container flex min-h-screen w-full">
        <aside class="w-64 bg-white shadow-lg flex flex-col p-4">
            <h2 class="text-xl font-bold text-amber-700 text-center mb-4 mt-4">النظام المالي</h2>
            <button onclick="showModule('main-menu-screen')" class="mb-4 text-sm text-blue-600 hover:underline"> &larr; العودة للقائمة الرئيسية</button>
            <nav class="flex-grow space-y-2">
                <a href="#" onclick="showPage('page-financial-dashboard', 'financial-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg><span>الملخص المالي</span></a>
                <a href="#" onclick="showPage('page-financial-transactions', 'financial-module-container')" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg><span>سجل المعاملات</span></a>
            </nav>
        </aside>
        <div class="flex-grow p-4 md:p-8 bg-slate-100">
            <main id="page-financial-dashboard" class="page">
                <h2 class="text-3xl font-bold text-slate-800">الملخص المالي</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-slate-500">إجمالي الإيرادات</h3><p id="total-revenue" class="text-2xl font-bold text-green-600">0 ر.س</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-slate-500">إجمالي المصروفات</h3><p id="total-expenses" class="text-2xl font-bold text-red-600">0 ر.س</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-slate-500">صافي الربح</h3><p id="net-profit" class="text-2xl font-bold text-sky-600">0 ر.س</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-amber-700 mb-4">الإيرادات مقابل المصروفات</h3>
                    <div class="chart-container"><canvas id="financial-summary-chart"></canvas></div>
                </div>
            </main>
            <main id="page-financial-transactions" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">سجل المعاملات المالية</h2>
                    <div class="flex gap-2">
                        <button onclick="openModal('addRevenueModal')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">إضافة إيراد</button>
                        <button onclick="openModal('addExpenseModal')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">إضافة مصروف</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th class="px-4 py-2">التاريخ</th>
                                    <th class="px-4 py-2">النوع</th>
                                    <th class="px-4 py-2">البند</th>
                                    <th class="px-4 py-2">الفئة</th>
                                    <th class="px-4 py-2">المبلغ (ر.س)</th>
                                    <th class="px-4 py-2 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="financial-transactions-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- MODULE: Invoicing System (no change) -->
    <div id="invoicing-module-container" class="module-container p-8 w-full"><button onclick="showModule('main-menu-screen')" class="mb-8 text-sm text-blue-600 hover:underline"> &larr; العودة للقائمة الرئيسية</button><div class="text-center"><h1 class="text-4xl font-bold text-slate-800">نظام الفوترة</h1><p class="text-slate-500 mt-4">هذا النظام قيد التطوير.</p></div></div>
    
    <!-- MODULE: HR System - تم التعديل هنا -->
    <div id="hr-module-container" class="module-container flex min-h-screen w-full">
        <aside class="w-64 bg-white shadow-lg flex flex-col p-4">
            <h2 class="text-xl font-bold text-violet-700 text-center mb-4 mt-4">شؤون الموظفين</h2>
            <button onclick="showModule('main-menu-screen')" class="mb-4 text-sm text-blue-600 hover:underline"> &larr; العودة للقائمة الرئيسية</button>
            <nav class="flex-grow space-y-2">
                <a href="#" onclick="showPage('page-employees', 'hr-module-container')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>الموظفين</span>
                </a>
                <a href="#" onclick="showPage('page-leaves', 'hr-module-container')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>الإجازات</span>
                </a>
                <a href="#" onclick="showPage('page-end-of-service', 'hr-module-container')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2A9 9 0 111 12a9 9 0 0118 0z" />
                    </svg>
                    <span>نهاية الخدمة</span>
                </a>
            </nav>
        </aside>
        <div class="flex-grow p-4 md:p-8 bg-slate-100">
            <!-- PAGE: Employees -->
            <main id="page-employees" class="page active">
                <h2 class="text-3xl font-bold text-slate-800">إدارة الموظفين</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <p class="text-slate-500">هذا القسم مخصص لإدارة بيانات الموظفين.</p>
                    <!-- هنا سيتم إضافة جدول الموظفين وأدوات الإدارة -->
                </div>
            </main>

            <!-- PAGE: Leaves -->
            <main id="page-leaves" class="page">
                <h2 class="text-3xl font-bold text-slate-800">إدارة الإجازات</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <p class="text-slate-500">هذا القسم مخصص لتسجيل وإدارة إجازات الموظفين.</p>
                    <!-- هنا سيتم إضافة جداول الإجازات والنماذج -->
                </div>
            </main>

            <!-- PAGE: End of Service -->
            <main id="page-end-of-service" class="page">
                <h2 class="text-3xl font-bold text-slate-800">نهاية الخدمة</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <p class="text-slate-500">هذا القسم مخصص لإجراءات نهاية خدمة الموظفين.</p>
                    <!-- هنا سيتم إضافة نماذج وإنهاء إجراءات الخدمة -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="addCompanyModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95"><h3 class="text-xl font-bold mb-4">إضافة عميل جديد</h3><form id="addCompanyForm"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="companyName" class="block mb-2 text-sm font-medium">اسم الشركة</label><input type="text" id="companyName" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="companyContact" class="block mb-2 text-sm font-medium">اسم المسؤول</label><input type="text" id="companyContact" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div><div class="md:col-span-2"><label for="companyAddress" class="block mb-2 text-sm font-medium">العنوان</label><input type="text" id="companyAddress" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div><div><label for="companyPhone" class="block mb-2 text-sm font-medium">رقم الاتصال</label><input type="tel" id="companyPhone" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div></div><div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse"><button type="button" onclick="closeModal('addCompanyModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button><button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">حفظ</button></div></form></div></div>
    
    <!-- Edit Company Modal -->
    <div id="editCompanyModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">تعديل بيانات العميل</h3>
            <form id="editCompanyForm">
                <input type="hidden" id="editCompanyId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editCompanyName" class="block mb-2 text-sm font-medium">اسم الشركة</label>
                        <input type="text" id="editCompanyName" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="editCompanyContact" class="block mb-2 text-sm font-medium">اسم المسؤول</label>
                        <input type="text" id="editCompanyContact" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                    </div>
                    <div class="md:col-span-2">
                        <label for="editCompanyAddress" class="block mb-2 text-sm font-medium">العنوان</label>
                        <input type="text" id="editCompanyAddress" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                    </div>
                    <div>
                        <label for="editCompanyPhone" class="block mb-2 text-sm font-medium">رقم الاتصال</label>
                        <input type="tel" id="editCompanyPhone" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('editCompanyModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addItemModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95"><h3 class="text-xl font-bold mb-4">تسكين صنف في موقع</h3><form id="addItemForm"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="itemLocation" class="block mb-2 text-sm font-medium">اختر الموقع</label><input type="text" list="locations-datalist" id="itemLocation" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="itemCompany" class="block mb-2 text-sm font-medium">الشركة</label><select id="itemCompany" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></select></div><div class="md:col-span-2"><label for="itemSKU" class="block mb-2 text-sm font-medium">SKU (رمز المنتج)</label><input type="text" id="itemSKU" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div class="md:col-span-2"><label for="itemName" class="block mb-2 text-sm font-medium">اسم الصنف</label><input type="text" id="itemName" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="itemQuantity" class="block mb-2 text-sm font-medium">العدد</label><input type="number" id="itemQuantity" min="1" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="itemPrice" class="block mb-2 text-sm font-medium">سعر الوحدة (ر.س)</label><input type="number" id="itemPrice" min="0" step="0.01" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div class="md:col-span-2"><label for="entryDate" class="block mb-2 text-sm font-medium">تاريخ الإدخال</label><input type="date" id="entryDate" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div></div><div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse"><button type="button" onclick="closeModal('addItemModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button><button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إضافة</button></div></form></div></div>
    <div id="importModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 transform scale-95"><h3 class="text-xl font-bold mb-4">استيراد المنتجات من ملف</h3><div class="bg-white p-6 rounded-xl space-y-6"><div class="flex justify-between items-center"><div><h3 class="text-lg font-semibold mb-2">الخطوة 1: ارفع ملف CSV</h3><p class="text-sm text-slate-500 mb-2">يجب أن يحتوي الملف على الأعمدة التالية بالترتيب: SKU, اسم المنتج, اسم الشركة, الموقع, العدد, سعر الوحدة</p></div><button onclick="downloadExampleCSV()" class="bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg text-sm">تحميل ملف مثال</button></div><input type="file" id="import-file-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/></div><div id="import-preview-container" class="hidden mt-4"><div><h3 class="text-lg font-semibold mb-2">الخطوة 2: معاينة البيانات وتحديد تاريخ الاستلام</h3><label for="delivery-date" class="block mb-2 text-sm font-medium">تاريخ الاستلام لجميع الأصناف في الملف:</label><input type="date" id="delivery-date" class="p-2 border rounded-lg mb-4"></div><div class="max-h-96 overflow-y-auto border rounded-lg"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0"><tr><th class="px-4 py-2">الحالة</th><th class="px-4 py-2">SKU</th><th class="px-4 py-2">اسم المنتج</th><th class="px-4 py-2">الشركة</th><th class="px-4 py-2">الموقع</th><th class="px-4 py-2">العدد</th><th class="px-4 py-2">السعر</th></tr></thead><tbody id="import-preview-body"></tbody></table></div><div class="mt-6"><h3 class="text-lg font-semibold mb-2">الخطوة 3: تأكيد الاستيراد</h3><button id="confirm-import-button" onclick="confirmImport()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">تأكيد الاستيراد (<span id="valid-rows-count">0</span>) أصناف صالحة</button></div></div><div class="mt-6 flex justify-end"><button type="button" onclick="closeModal('importModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إغلاق</button></div></div></div>
    
    <!-- MODIFIED TRANSACTION MODALS -->
    <div id="addTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">تسجيل حركة إضافة</h3>
            <form id="addInventoryForm">
                 <!-- Step 1: Choose between existing and new -->
                <div id="add-trans-initial-step">
                    <label for="add-trans-sku-select" class="block mb-2 text-sm font-medium">ابحث عن صنف موجود (بالـ SKU) أو اختره من القائمة</label>
                    <input type="text" id="add-trans-sku-select" list="sku-datalist" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" placeholder="أدخل SKU...">
                    <div id="add-trans-sku-error" class="text-red-500 text-sm mt-1 hidden">لم يتم العثور على الصنف. يمكنك إضافته كصنف جديد.</div>
                    
                    <div class="my-4 text-center text-slate-500">أو</div>
                    
                    <button type="button" id="add-new-item-btn" class="w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors">إضافة صنف جديد كلياً</button>
                </div>

                <!-- Step 2 (Option A): Add to existing SKU -->
                <div id="add-trans-existing-item-details" class="hidden space-y-4">
                     <button type="button" id="change-sku-btn" class="text-sm text-blue-600 hover:underline mb-2">&larr; تغيير الصنف</button>
                     <div class="p-3 bg-slate-100 rounded-lg">
                        <p><strong>الصنف المحدد:</strong> <span id="selected-sku-name" class="font-bold"></span></p>
                        <p class="text-sm"><strong>SKU:</strong> <span id="selected-sku-code"></span></p>
                     </div>
                     
                     <div>
                        <label for="add-trans-location" class="block mb-2 text-sm font-medium">الموقع (اختر موقعاً حالياً لزيادة الكمية، أو موقعاً فارغاً جديداً)</label>
                        <input type="text" id="add-trans-location" list="locations-datalist" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" placeholder="مثال: A-01-01">
                     </div>
                    
                     <div>
                        <label for="add-trans-date" class="block mb-2 text-sm font-medium">تاريخ الإضافة</label>
                        <input type="date" id="add-trans-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                     </div>
                     
                     <div>
                        <label for="add-trans-quantity" class="block mb-2 text-sm font-medium">الكمية المضافة</label>
                        <input type="number" id="add-trans-quantity" min="1" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                     </div>

                     <div>
                        <label for="add-trans-reason" class="block mb-2 text-sm font-medium">سبب الإضافة</label>
                        <select id="add-trans-reason" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                            <option value="استلام جديد">استلام جديد</option>
                            <option value="إرجاع طلب">إرجاع طلب</option>
                            <option value="إضافة يدوية">إضافة يدوية</option>
                        </select>
                     </div>
                </div>

                <!-- Step 2 (Option B): Add new item form -->
                <div id="add-trans-new-item-form" class="hidden space-y-4">
                     <button type="button" id="back-to-search-btn" class="text-sm text-blue-600 hover:underline mb-2">&larr; العودة للبحث</button>
                     <h4 class="font-bold text-lg">تفاصيل الصنف الجديد</h4>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="new-form-sku" class="block mb-2 text-sm font-medium">SKU (رمز المنتج)</label><input type="text" id="new-form-sku" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div><label for="new-form-name" class="block mb-2 text-sm font-medium">اسم الصنف</label><input type="text" id="new-form-name" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div><label for="new-form-company" class="block mb-2 text-sm font-medium">الشركة</label><select id="new-form-company" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></select></div>
                        <div><label for="new-form-price" class="block mb-2 text-sm font-medium">سعر الوحدة (ر.س)</label><input type="number" id="new-form-price" min="0" step="0.01" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <hr class="md:col-span-2">
                        <div><label for="new-form-location" class="block mb-2 text-sm font-medium">الموقع</label><input type="text" list="locations-datalist" id="new-form-location" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div><label for="new-form-quantity" class="block mb-2 text-sm font-medium">الكمية</label><input type="number" id="new-form-quantity" min="1" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div><label for="new-form-date" class="block mb-2 text-sm font-medium">تاريخ الإضافة</label><input type="date" id="new-form-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div class="md:col-span-2"><label for="new-form-reason" class="block mb-2 text-sm font-medium">سبب الإضافة</label><select id="new-form-reason" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"><option value="استلام جديد">استلام جديد</option><option value="إرجاع طلب">إرجاع طلب</option></select></div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('addTransactionModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">إلغاء</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">تأكيد الإضافة</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="dispatchTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">تسجيل صرف مخزني</h3>
            <form id="dispatchInventoryForm">
                <div class="space-y-4">
                    <div>
                        <label for="dispatch-trans-sku-search" class="block mb-2 text-sm font-medium">ابحث عن الصنف باستخدام SKU</label>
                        <input type="text" id="dispatch-trans-sku-search" list="sku-datalist" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" placeholder="أدخل SKU...">
                    </div>
                    <div id="dispatch-sku-search-results" class="space-y-2 max-h-40 overflow-y-auto"></div>
                    <hr>
                    <div>
                        <label for="dispatch-trans-quantity" class="block mb-2 text-sm font-medium">الكمية المصروفة</label>
                        <input type="number" id="dispatch-trans-quantity" min="1" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="dispatch-trans-reason" class="block mb-2 text-sm font-medium">سبب الصرف</label>
                        <select id="dispatch-trans-reason" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required>
                            <option value="صرف يدوي">صرف يدوي</option>
                            <option value="بناء على طلب">بناء على طلب</option>
                            <option value="تلف">تلف</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('dispatchTransactionModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">إلغاء</button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">تأكيد الصرف</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alertModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform scale-95 text-center"><h3 id="alertModalTitle" class="text-xl font-bold mb-4"></h3><p id="alertModalMessage" class="mb-6"></p><div id="alertModalButtons" class="flex justify-center space-x-2 rtl:space-x-reverse"></div></div></div>
    <div id="shelf-tooltip" class="shelf-tooltip"></div>
    <div id="addZoneModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95"><h3 class="text-xl font-bold mb-4">إضافة / تعديل منطقة</h3><form id="addZoneForm"><input type="hidden" id="zone-edit-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="zone-id" class="block mb-2 text-sm font-medium">معرف المنطقة (حرف إنجليزي واحد)</label><input type="text" id="zone-id" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required maxlength="1"></div><div><label for="zone-name" class="block mb-2 text-sm font-medium">اسم المنطقة</label><input type="text" id="zone-name" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="zone-columns" class="block mb-2 text-sm font-medium">عدد الأعمدة</label><input type="number" id="zone-columns" min="1" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="zone-shelves" class="block mb-2 text-sm font-medium">عدد الرفوف لكل عمود</label><input type="number" id="zone-shelves" min="1" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div></div><div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse"><button type="button" onclick="closeModal('addZoneModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button><button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">حفظ</button></div></form></div></div>
    <!-- Financial Modals -->
    <div id="addRevenueModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95"><h3 class="text-xl font-bold mb-4 text-green-600">إضافة إيراد جديد</h3><form id="addRevenueForm"><div class="space-y-4"><div><label for="revenue-date" class="block mb-2 text-sm font-medium">التاريخ</label><input type="date" id="revenue-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="revenue-description" class="block mb-2 text-sm font-medium">بند الإيراد</label><input type="text" id="revenue-description" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required placeholder="مثال: مبيعات منتج س"></div><div><label for="revenue-category" class="block mb-2 text-sm font-medium">الفئة</label><select id="revenue-category" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required><option value="مبيعات">مبيعات</option><option value="خدمات">خدمات</option><option value="أخرى">أخرى</option></select></div><div><label for="revenue-amount" class="block mb-2 text-sm font-medium">المبلغ</label><input type="number" id="revenue-amount" min="0" step="0.01" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div></div><div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse"><button type="button" onclick="closeModal('addRevenueModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">حفظ الإيراد</button></div></form></div></div>
    <div id="addExpenseModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95"><h3 class="text-xl font-bold mb-4 text-red-600">إضافة مصروف جديد</h3><form id="addExpenseForm"><div class="space-y-4"><div><label for="expense-date" class="block mb-2 text-sm font-medium">التاريخ</label><input type="date" id="expense-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div><div><label for="expense-description" class="block mb-2 text-sm font-medium">بند المصروف</label><input type="text" id="expense-description" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required placeholder="مثال: فاتورة كهرباء"></div><div><label for="expense-category" class="block mb-2 text-sm font-medium">الفئة</label><select id="expense-category" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required><option value="رواتب">رواتب</option><option value="إيجار">إيجار</option><option value="فواتير">فواتير</option><option value="مشتريات">مشتريات</option><option value="تسويق">تسويق</option><option value="أخرى">أخرى</option></select></div><div><label for="expense-amount" class="block mb-2 text-sm font-medium">المبلغ</label><input type="number" id="expense-amount" min="0" step="0.01" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div></div><div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse"><button type="button" onclick="closeModal('addExpenseModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">إلغاء</button><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">حفظ المصروف</button></div></form></div></div>
    <datalist id="sku-datalist"></datalist>
    <datalist id="locations-datalist"></datalist>
    <div id="printable-invoice"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, writeBatch, deleteDoc, updateDoc, runTransaction, setDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyDSlxf95W00Ow6LZba8waAKJINptIRPkU8", authDomain: "sample-firebase-ai-app-960f4.firebaseapp.com", projectId: "sample-firebase-ai-app-960f4", storageBucket: "sample-firebase-ai-app-960f4.appspot.com", messagingSenderId: "741880884079", appId: "1:741880884079:web:8d2f6e233fb65e65e969a" };
        
        let app, auth, db, userId;
        let companiesUnsubscribe, inventoryUnsubscribe, transactionsUnsubscribe, layoutUnsubscribe, financialsUnsubscribe;
        let state = { companies: [], inventory: [], transactions: [], warehouseConfig: {}, financials: [] };
        let parsedFileData = [], confirmationCallback = null, companyValueChart = null, financialSummaryChart = null, allLocations = new Set();
        let skuSearchTimeout;


        const ui = {
            loginScreen: document.getElementById('login-screen'),
            mainMenuScreen: document.getElementById('main-menu-screen'),
            userDisplayName: document.getElementById('main-menu-user-display-name'),
            searchInput: document.getElementById('search-input'),
            tooltip: document.getElementById('shelf-tooltip'),
            importFileInput: document.getElementById('import-file-input'),
            importPreviewContainer: document.getElementById('import-preview-container'),
            layoutHeader: document.getElementById('layout-header'),
            layoutViewsContainer: document.getElementById('layout-views-container'),
            zonesView: document.getElementById('layout-zones-view'),
            zoneDetailView: document.getElementById('layout-zone-detail-view'),
            settingsContainer: document.getElementById('warehouse-settings-container'),
            addZoneForm: document.getElementById('addZoneForm'),
            // عناصر جديدة لدخول الايميل والباسوورد
            loginEmailInput: document.getElementById('login-email'),
            loginPasswordInput: document.getElementById('login-password'),
            emailLoginForm: document.getElementById('email-password-form'),
            emailLoginButton: document.getElementById('email-login-button'),
            emailSignupButton: document.getElementById('email-signup-button')
        };
        
        window.openModal = (modalId, context = null) => {
            const modal = document.getElementById(modalId);
            if (modalId === 'addItemModal') {
                document.getElementById('addItemForm').reset();
                document.getElementById('entryDate').valueAsDate = new Date();
                const occupiedLocations = new Set(state.inventory.map(item => item.locationId));
                const emptyLocations = Array.from(allLocations).filter(loc => !occupiedLocations.has(loc));
                document.getElementById('locations-datalist').innerHTML = emptyLocations.sort().map(loc => `<option value="${loc}"></option>`).join('');
                populateCompanySelects('itemCompany');
            } else if (modalId === 'addTransactionModal') {
                document.getElementById('addInventoryForm').reset();
                // Reset to initial state
                document.getElementById('add-trans-initial-step').classList.remove('hidden');
                document.getElementById('add-trans-existing-item-details').classList.add('hidden');
                document.getElementById('add-trans-new-item-form').classList.add('hidden');
                document.getElementById('add-trans-sku-error').classList.add('hidden');
                document.getElementById('new-form-date').valueAsDate = new Date();
                populateDatalists();
                populateCompanySelects('new-form-company');
            } else if (modalId === 'dispatchTransactionModal') {
                document.getElementById('dispatchInventoryForm').reset();
                document.getElementById('dispatch-sku-search-results').innerHTML = '';
                populateDatalists();
            } else if (modalId === 'addZoneModal') {
                ui.addZoneForm.reset();
                const title = modal.querySelector('h3');
                if (context) {
                    title.textContent = 'تعديل المنطقة';
                    document.getElementById('zone-edit-id').value = context.id;
                    document.getElementById('zone-id').value = context.id;
                    document.getElementById('zone-id').disabled = true;
                    document.getElementById('zone-name').value = context.name;
                    document.getElementById('zone-columns').value = context.columns;
                    document.getElementById('zone-shelves').value = context.shelvesPerColumn;
                } else {
                    title.textContent = 'إضافة منطقة جديدة';
                    document.getElementById('zone-edit-id').value = '';
                    document.getElementById('zone-id').disabled = false;
                }
            } else if (modalId === 'addRevenueModal' || modalId === 'addExpenseModal') {
                modal.querySelector('form').reset();
                modal.querySelector('input[type="date"]').valueAsDate = new Date();
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
        };
        
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        const showAlert = (title, message) => {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').innerHTML = message;
            document.getElementById('alertModalButtons').innerHTML = `<button type="button" onclick="closeModal('alertModal')" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">حسنًا</button>`;
            openModal('alertModal');
        };
        
        const showConfirmation = (title, message, onConfirm) => {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            document.getElementById('alertModalButtons').innerHTML = `<button type="button" onclick="closeModal('alertModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-6 rounded-lg transition-colors">إلغاء</button><button type="button" onclick="handleConfirm()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">تأكيد</button>`;
            confirmationCallback = onConfirm;
            openModal('alertModal');
        };

        window.handleConfirm = () => { if (confirmationCallback) { confirmationCallback(); } closeModal('alertModal'); confirmationCallback = null; };
        
        window.showModule = (moduleId) => { 
            document.querySelectorAll('.module-container').forEach(mc => mc.style.display = 'none'); 
            ui.mainMenuScreen.style.display = 'none'; 
            ui.loginScreen.style.display = 'none'; 
            const targetModule = document.getElementById(moduleId); 
            targetModule.style.display = 'flex'; 
            if (moduleId === 'main-menu-screen') { 
                targetModule.style.display = 'block'; 
            } else if (moduleId === 'inventory-module-container') { 
                showPage('page-layout', moduleId); 
            } else if (moduleId === 'financial-module-container') {
                showPage('page-financial-dashboard', moduleId);
            } else if (moduleId === 'hr-module-container') { /* تحديث: تحديد الصفحة الافتراضية لقسم شؤون الموظفين */
                showPage('page-employees', moduleId); // عرض صفحة الموظفين افتراضياً
            }
        };

        window.showPage = (pageId, moduleContainerId) => {
            const module = document.getElementById(moduleContainerId);
            module.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            module.querySelector(`#${pageId}`).classList.add('active');
            module.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active'));
            module.querySelector(`.sidebar-link[onclick*="'${pageId}'"]`).classList.add('active');
            
            if (pageId === "page-layout") { renderLayoutView('zones'); }
            
            if (pageId === 'page-reports') {
                document.getElementById('report-end-date').valueAsDate = new Date();
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                document.getElementById('report-start-date').valueAsDate = oneMonthAgo;

                document.getElementById('billing-end-date').valueAsDate = new Date();
                const firstDayOfMonth = new Date();
                firstDayOfMonth.setDate(1);
                document.getElementById('billing-start-date').valueAsDate = firstDayOfMonth;
            }
        };
        
        function renderAll() { 
            renderDashboard(); 
            renderCustomersPage(); 
            renderInventoryPage(); 
            renderTransactionsPage(); 
            renderSettingsPage(); 
            populateCompanySelects("billing-company");
            renderOrUpdateInventoryChart(); 
            if (document.getElementById('page-layout').classList.contains('active')) { 
                renderLayoutView(ui.layoutViewsContainer.dataset.currentView || 'zones', ui.layoutViewsContainer.dataset.context ? JSON.parse(ui.layoutViewsContainer.dataset.context) : null); 
            }
            renderFinancialDashboard();
            renderFinancialTransactionsPage();
            renderOrUpdateFinancialChart();
            // ليس هناك حاجة لوظائف render خاصة بصفحات الموارد البشرية الجديدة في هذا التعديل
            // لأنها تحتوي على محتوى ثابت مبدئيًا. إذا أضفت بيانات ديناميكية، فستحتاج إليها.
        }
        
        window.renderLayoutView = (view, context) => {
            ui.layoutViewsContainer.dataset.currentView = view;
            if(context) ui.layoutViewsContainer.dataset.context = JSON.stringify(context);
            document.querySelectorAll('.layout-view').forEach(v => v.classList.remove('active'));
            if (view === 'zone-detail') {
                renderZoneDetailView(context);
            } else {
                renderZonesView();
            }
        }
        function renderZonesView() {
            ui.layoutHeader.innerHTML = `<h2 class="text-3xl font-bold text-slate-800">مخطط المستودع</h2><div class="flex items-center gap-2"><input type="text" id="sku-search-input" placeholder="ابحث عن SKU..." class="w-full sm:w-64 p-2 border border-slate-300 rounded-lg"><button onclick="searchBySku()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">بحث</button></div>`;
            const occupiedLocations = new Set(state.inventory.map(i => i.locationId));
            ui.zonesView.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">${Object.keys(state.warehouseConfig).sort().map(zoneId => {
                const zone = state.warehouseConfig[zoneId];
                if(!zone) return '';
                const totalShelves = zone.columns * zone.shelvesPerColumn;
                const occupiedCount = Array.from(occupiedLocations).filter(loc => loc.startsWith(zoneId)).length;
                const percentage = totalShelves > 0 ? ((occupiedCount / totalShelves) * 100).toFixed(1) : 0;
                return `<div onclick="renderLayoutView('zone-detail', '${zoneId}')" class="zone-card bg-white p-6 rounded-xl shadow-lg cursor-pointer text-center">
                    <h3 class="text-2xl font-bold text-teal-600">المنطقة ${zoneId}</h3>
                    <p class="text-slate-500 mt-2">${zone.name}</p>
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mt-4"><div class="bg-teal-500 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                    <p class="mt-2 text-sm font-semibold">${occupiedCount} / ${totalShelves} موقع مشغول (${percentage}%)</p>
                </div>`;
            }).join('')}</div>`;
            ui.zonesView.classList.add('active');
        }
        
        function renderZoneDetailView(zoneId) {
            ui.layoutHeader.innerHTML = `<div class="flex items-center gap-4"><button onclick="renderLayoutView('zones')" class="text-blue-600">&larr; عودة للمناطق</button><h2 class="text-3xl font-bold text-slate-800">تفاصيل المنطقة ${zoneId}</h2></div>`;
            const zone = state.warehouseConfig[zoneId];
            if(!zone){ renderZonesView(); return; }

            const occupiedMap = new Map();
            state.inventory.forEach(item => {
                if(item.locationId.startsWith(zoneId)){
                    if(!occupiedMap.has(item.locationId)) occupiedMap.set(item.locationId, []);
                    occupiedMap.get(item.locationId).push(item);
                }
            });

            let detailHTML = `<div class="bg-white p-4 rounded-xl shadow-lg"><div class="shelf-column-container">`;

            for (let c = 1; c <= zone.columns; c++) {
                const colId = c.toString().padStart(2, '0');
                detailHTML += `<div class="shelf-column space-y-2 p-2 bg-slate-50 rounded-lg"><h4 class="text-center font-bold text-sky-700">عمود ${colId}</h4>`;
                for (let s = 1; s <= zone.shelvesPerColumn; s++) {
                    const shelfId = s.toString().padStart(2, '0'), locationId = `${zoneId}-${colId}-${shelfId}`;
                    const items = occupiedMap.get(locationId);
                    const tooltipText = items ? items.map(item => `SKU: ${item.sku} (الكمية: ${item.quantity})`).join('<br>') : `الموقع: ${locationId}<br>الحالة: فارغ`;
                    detailHTML += `<div id="${locationId}" data-tooltip="${tooltipText}" class="shelf ${items ? 'occupied' : 'available'}">
                        <span class="font-bold">${locationId}</span>
                        <span class="text-xs">${items ? `(${items.length} أصناف)` : ''}</span>
                    </div>`;
                }
                detailHTML += '</div>';
            }
            detailHTML += '</div></div>';
            ui.zoneDetailView.innerHTML = detailHTML;
            ui.zoneDetailView.classList.add('active');
            addTooltipEvents();
        }

        function renderDashboard() {
            const todayStr = new Date().toISOString().slice(0, 10);
            document.getElementById('total-companies').textContent = state.companies.length;
            document.getElementById('total-items').textContent = state.inventory.reduce((sum, item) => sum + Number(item.quantity), 0);
            document.getElementById('total-value').textContent = `${state.inventory.reduce((sum, item) => sum + (Number(item.quantity) * Number(item.price)), 0).toLocaleString('ar-SA')} ر.س`;
            document.getElementById('today-items').textContent = state.inventory.filter(item => item.entryDate === todayStr).length;
        }
        function renderCustomersPage() {
            const tableBody = document.getElementById('customers-table-body');
            if (state.companies.length === 0) { tableBody.innerHTML = '<tr class="border-b"><td colspan="7" class="text-center p-4">لا يوجد عملاء مضافون.</td></tr>'; return }
            tableBody.innerHTML = state.companies.sort((a, b) => a.name.localeCompare(b.name)).map(company => {
                let locationCount = new Set(state.inventory.filter(item => item.companyId === company.id).map(item => item.locationId)).size;
                const quantityCount = state.inventory.filter(item => item.companyId === company.id).reduce((sum, item) => sum + item.quantity, 0);
                return `<tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium text-slate-900">${company.name}</td>
                    <td class="px-6 py-4">${company.contact || '-'}</td>
                    <td class="px-6 py-4">${company.address || '-'}</td>
                    <td class="px-6 py-4">${company.phone || '-'}</td>
                    <td class="px-6 py-4">${locationCount}</td>
                    <td class="px-6 py-4">${quantityCount}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="openEditCompanyModal('${company.id}')" class="text-blue-600 hover:text-blue-800 font-bold px-2">تعديل</button>
                        <button onclick="deleteCompany('${company.id}')" class="text-red-600 hover:text-red-800 font-bold px-2">حذف</button>
                    </td>
                </tr>`
            }).join("")
        }
        function renderInventoryPage() {
            const tableBody = document.getElementById('inventory-table-body');
            const searchTerm = ui.searchInput.value.toLowerCase();
            const filteredInventory = state.inventory.filter(item => item.name.toLowerCase().includes(searchTerm) || (state.companies.find(c => c.id === item.companyId)?.name || "").toLowerCase().includes(searchTerm) || item.locationId.toLowerCase().includes(searchTerm) || (item.sku && item.sku.toLowerCase().includes(searchTerm)));
            if (filteredInventory.length === 0) { tableBody.innerHTML = `<tr class="border-b"><td colspan="8" class="text-center p-4">${state.inventory.length === 0 ? "لا توجد أصناف في المخزن." : "لا توجد نتائج تطابق بحثك."}</td></tr>`; return }
            tableBody.innerHTML = filteredInventory.sort((a, b) => a.locationId.localeCompare(b.locationId) || a.sku.localeCompare(b.sku)).map(item => {
                const company = state.companies.find(c => c.id === item.companyId);
                return `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-bold text-slate-900">${item.locationId}</td><td class="px-6 py-4">${item.sku || "N/A"}</td><td class="px-6 py-4">${item.name}</td><td class="px-6 py-4">${company ? company.name : "غير محدد"}</td><td class="px-6 py-4">${item.quantity}</td><td class="px-6 py-4">${Number(item.price).toLocaleString("ar-SA")} ر.س</td><td class="px-6 py-4">${item.entryDate}</td><td class="px-6 py-4 text-center"><button onclick="openDispatchModal('${item.id}')" class="bg-amber-500 text-white px-3 py-1 text-xs rounded-md hover:bg-amber-600">إخلاء الصنف</button></td></tr>`
            }).join("")
        }
        function renderTransactionsPage() {
            const tableBody = document.getElementById('transactions-table-body');
            if (state.transactions.length === 0) { tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">لا توجد حركات مسجلة.</td></tr>'; return }
            tableBody.innerHTML = state.transactions.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis()).map(t => {
                const isAdd = t.type === 'add';
                return `<tr class="bg-white border-b"><td class="px-4 py-2 text-sm text-slate-500">${new Date(t.timestamp.toMillis()).toLocaleString("en-CA")}</td><td class="px-4 py-2 font-semibold ${isAdd ? "text-green-600" : "text-red-600"}">${isAdd ? "إضافة" : "صرف"}</td><td class="px-4 py-2">${t.reason}</td><td class="px-4 py-2">${t.itemSku}</td><td class="px-4 py-2">${t.itemName}</td><td class="px-4 py-2">${t.quantity}</td></tr>`
            }).join('')
        }
        function renderSettingsPage() {
            ui.settingsContainer.innerHTML = '';
            if (Object.keys(state.warehouseConfig).length === 0) {
                ui.settingsContainer.innerHTML = `<p class="text-center text-slate-500">لم يتم العثور على إعدادات. يمكنك إضافة منطقة جديدة.</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-slate-500';
            table.innerHTML = `
                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                    <tr>
                        <th class="px-6 py-3">معرف المنطقة</th>
                        <th class="px-6 py-3">اسم المنطقة</th>
                        <th class="px-6 py-3">الأعمدة</th>
                        <th class="px-6 py-3">الرفوف/عمود</th>
                        <th class="px-6 py-3 text-center">إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                ${Object.keys(state.warehouseConfig).sort().map(zoneId => {
                    const zone = state.warehouseConfig[zoneId];
                    return `<tr class="bg-white border-b">
                        <td class="px-6 py-4 font-bold">${zoneId}</td>
                        <td class="px-6 py-4">${zone.name}</td>
                        <td class="px-6 py-4">${zone.columns}</td>
                        <td class="px-6 py-4">${zone.shelvesPerColumn}</td>
                        <td class="px-6 py-4 text-center">
                            <button onclick='openModal("addZoneModal", ${JSON.stringify({...zone, id: zoneId})})' class="text-blue-600 hover:underline">تعديل</button>
                            <button onclick='deleteZone("${zoneId}")' class="text-red-600 hover:underline mr-4">حذف</button>
                        </td>
                    </tr>`;
                }).join('')}
                </tbody>
            `;
            ui.settingsContainer.appendChild(table);
        }

        function renderFinancialDashboard() {
            const totalRevenue = state.financials.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = state.financials.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netProfit = totalRevenue - totalExpenses;

            document.getElementById('total-revenue').textContent = `${totalRevenue.toLocaleString('ar-SA')} ر.س`;
            document.getElementById('total-expenses').textContent = `${totalExpenses.toLocaleString('ar-SA')} ر.س`;
            document.getElementById('net-profit').textContent = `${netProfit.toLocaleString('ar-SA')} ر.س`;
            document.getElementById('net-profit').style.color = netProfit >= 0 ? '#0ea5e9' : '#ef4444';
        }
        
        function renderFinancialTransactionsPage() {
            const tableBody = document.getElementById('financial-transactions-table-body');
            if (state.financials.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">لا توجد معاملات مالية مسجلة.</td></tr>';
                return;
            }
            tableBody.innerHTML = state.financials.sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => {
                const isRevenue = t.type === 'revenue';
                return `<tr class="bg-white border-b">
                    <td class="px-4 py-2">${t.date}</td>
                    <td class="px-4 py-2 font-semibold ${isRevenue ? "text-green-600" : "text-red-600"}">${isRevenue ? "إيراد" : "مصروف"}</td>
                    <td class="px-4 py-2">${t.description}</td>
                    <td class="px-4 py-2">${t.category}</td>
                    <td class="px-4 py-2">${t.amount.toLocaleString('ar-SA')}</td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="deleteFinancialTransaction('${t.id}')" class="text-red-500 hover:text-red-700 font-bold px-2">حذف</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function populateCompanySelects(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">اختر شركة...</option>';
            state.companies.sort((a, b) => a.name.localeCompare(b.name)).forEach(company => {
                select.innerHTML += `<option value="${company.id}">${company.name}</option>`
            });
            select.value = currentValue
        }
       
        function populateDatalists() {
            const skuDatalist = document.getElementById('sku-datalist');
            const locationsDatalist = document.getElementById('locations-datalist');
            const uniqueSkus = [...new Set(state.inventory.map(item => item.sku))];
            skuDatalist.innerHTML = uniqueSkus.map(sku => `<option value="${sku}"></option>`).join('');
            
            locationsDatalist.innerHTML = Array.from(allLocations).sort().map(loc => `<option value="${loc}"></option>`).join('');
        }
        function renderOrUpdateInventoryChart() {
            const ctx = document.getElementById('company-value-chart').getContext('2d');
            if (!state.companies.length || !state.inventory.length) {
                if (companyValueChart) { companyValueChart.destroy(); companyValueChart = null; }
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Cairo"; ctx.textAlign = "center"; ctx.fillStyle = "#9ca3af";
                ctx.fillText("لا توجد بيانات كافية لعرض الرسم البياني", ctx.canvas.width / 2, ctx.canvas.height / 2);
                return
            }
            const data = state.companies.map(c => ({
                name: c.name,
                value: state.inventory.filter(i => i.companyId === c.id).reduce((sum, i) => sum + (i.quantity * i.price), 0)
            })).filter(c => c.value > 0);
            const chartData = {
                labels: data.map(d => d.name),
                datasets: [{
                    label: 'قيمة المخزون',
                    data: data.map(d => d.value),
                    backgroundColor: ['#14b8a6', '#0ea5e9', '#f59e0b', '#f43f5e', '#8b5cf6', '#22c55e'],
                    hoverOffset: 4
                }]
            };
            if (companyValueChart) { companyValueChart.data = chartData; companyValueChart.update() } 
            else { companyValueChart = new Chart(ctx, { type: 'pie', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { family: 'Cairo' } } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.formattedValue} ر.س` } } } } }); }
        }
        function renderOrUpdateFinancialChart() {
            const ctx = document.getElementById('financial-summary-chart').getContext('2d');
            const totalRevenue = state.financials.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = state.financials.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            const chartData = {
                labels: ['الإيرادات', 'المصروفات'],
                datasets: [{
                    label: 'الملخص المالي',
                    data: [totalRevenue, totalExpenses],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderColor: ['#059669', '#dc2626'],
                    borderWidth: 1
                }]
            };

            if (financialSummaryChart) {
                financialSummaryChart.data = chartData;
                financialSummaryChart.update();
            } else {
                financialSummaryChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { callback: (value) => `${value} ر.س` } } },
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.formattedValue} ر.س` } } }
                    }
                });
            }
        }
        function addTooltipEvents() { document.querySelectorAll(".shelf").forEach(e => { e.addEventListener("mousemove", t => { ui.tooltip.style.display = "block", ui.tooltip.style.left = `${t.pageX + 15}px`, ui.tooltip.style.top = `${t.pageY + 15}px`, ui.tooltip.innerHTML = e.dataset.tooltip }), e.addEventListener("mouseleave", () => { ui.tooltip.style.display = "none" }) }) }
        
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, e => {
                    if (e) {
                        userId = e.uid;
                        ui.loginScreen.style.display = "none";
                        ui.mainMenuScreen.style.display = "block";
                        document.querySelectorAll(".module-container").forEach(c => c.style.display = "none");
                        ui.userDisplayName.textContent = e.displayName || e.email;
                        setupRealtimeListeners()
                    } else {
                        clearDataAndListeners();
                        ui.loginScreen.style.display = "flex";
                        ui.mainMenuScreen.style.display = "none";
                        document.querySelectorAll(".module-container").forEach(c => c.style.display = "none")
                    }
                })
            } catch (e) { console.error("Firebase initialization error:", e) }
        }
        
        // ** وظائف جديدة لتسجيل الدخول وإنشاء حساب بالبريد الإلكتروني وكلمة المرور **
        window.signInWithEmail = async (event) => {
            event.preventDefault();
            const email = ui.loginEmailInput.value.trim();
            const password = ui.loginPasswordInput.value.trim();

            if (!email || !password) {
                showAlert("بيانات ناقصة", "الرجاء إدخال البريد الإلكتروني وكلمة المرور.");
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let errorMessage = "فشل تسجيل الدخول. يرجى التحقق من بريدك الإلكتروني وكلمة المرور.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "صيغة البريد الإلكتروني غير صحيحة.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "تم حظر هذا الحساب مؤقتًا بسبب محاولات تسجيل دخول فاشلة متعددة. حاول لاحقًا.";
                }
                showAlert("خطأ في تسجيل الدخول", errorMessage);
                console.error("Email sign-in error:", error);
            }
        };

        window.signUpWithEmail = async () => {
            const email = ui.loginEmailInput.value.trim();
            const password = ui.loginPasswordInput.value.trim();

            if (!email || !password) {
                showAlert("بيانات ناقصة", "الرجاء إدخال البريد الإلكتروني وكلمة المرور لإنشاء حساب.");
                return;
            }

            if (password.length < 6) {
                showAlert("كلمة مرور ضعيفة", "يجب أن تتكون كلمة المرور من 6 أحرف على الأقل.");
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showAlert("نجاح", "تم إنشاء حسابك بنجاح! يمكنك الآن تسجيل الدخول.");
                // يمكن مسح حقول الإدخال أو ترك المستخدم ليسجل الدخول تلقائيا بعد الإنشاء
                // ui.loginEmailInput.value = '';
                // ui.loginPasswordInput.value = '';
            } catch (error) {
                let errorMessage = "فشل إنشاء الحساب. يرجى المحاولة مرة أخرى.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "هذا البريد الإلكتروني مستخدم بالفعل. يرجى تسجيل الدخول أو استخدام بريد إلكتروني آخر.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "صيغة البريد الإلكتروني غير صالحة.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "كلمة المرور ضعيفة جداً. يرجى استخدام كلمة مرور أقوى.";
                }
                showAlert("خطأ في إنشاء الحساب", errorMessage);
                console.error("Email sign-up error:", error);
            }
        };


        window.signInWithGoogle = async () => { 
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                let errorMessage = "لم نتمكن من تسجيل دخولك باستخدام جوجل. يرجى المحاولة مرة أخرى.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "تم إغلاق نافذة تسجيل الدخول بواسطة المستخدم.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                     errorMessage = "طلب تسجيل الدخول عبر النافذة المنبثقة تم إلغاؤه.";
                } else if (error.code === 'auth/unauthorized-domain') {
                     errorMessage = "النطاق الحالي غير مصرح به في إعدادات مشروع Firebase. يرجى مراجعة إعدادات Firebase Authorized Domains.";
                }
                showAlert("فشل تسجيل الدخول", errorMessage);
                console.error("Google sign-in error:", error);
            } 
        };
        window.signOutUser = async () => { try { await signOut(auth) } catch (e) { showAlert("خطأ", "فشلت عملية تسجيل الخروج.") } };
        
        function clearDataAndListeners() {
            companiesUnsubscribe && companiesUnsubscribe();
            inventoryUnsubscribe && inventoryUnsubscribe();
            transactionsUnsubscribe && transactionsUnsubscribe();
            layoutUnsubscribe && layoutUnsubscribe();
            financialsUnsubscribe && financialsUnsubscribe();
            state = { companies: [], inventory: [], transactions: [], warehouseConfig: {}, financials: [] };
            renderAll()
        }
        
        function setupRealtimeListeners() {
            clearDataAndListeners();
            // تحديد userId: إذا لم يكن المستخدم موجودًا، استخدم معرفًا افتراضيًا أو anonymous
            // هذا لضمان أن التطبيق يعمل حتى لو لم يكن المستخدم مسجلاً للدخول،
            // مع العلم أن قواعد أمان Firebase يجب أن تسمح بالوصول لهذه البيانات.
            // إذا كنت ترغب في أن يشارك جميع المستخدمين نفس البيانات بدون تسجيل دخول،
            // فستحتاج إلى استخدام UID ثابت هنا (مثل 'guest_user' أو 'shared_data_id')
            // وتعديل قواعد أمان Firestore للسماح للقراءة/الكتابة بدون مصادقة لهذا الـ UID.
            // حالياً، الكود يفترض وجود مستخدم مصادق عليه (e.uid).
            // إذا كنت تريد فتح التطبيق بدون مصادقة، ستحتاج إلى تعيين userId بطريقة مختلفة
            // والسماح بالوصول في قواعد Firestore.
            if (!userId) { // هذا الجزء مضاف لاحتمال "استثناء الدخول"
                userId = "shared_public_data"; // معرف ثابت للبيانات العامة
                // يجب تعديل قواعد أمان Firestore للسماح بالوصول إلى "shared_public_data"
                // مثال لقاعدة Firestore العامة (للقراءة فقط):
                // match /inventory-data/shared_public_data/{document=**} {
                //   allow read: if true;
                //   allow write: if false; // لا تسمح بالكتابة للمستخدمين غير المصادق عليهم
                // }
                // إذا كنت تريد السماح بالكتابة أيضًا، فستكون: allow read, write: if true;
                // ولكن هذا غير آمن في بيئة عامة.
                // للحفاظ على الأمان مع "استثناء الدخول" والوصول للبيانات، يفضل استخدام
                // `signInAnonymously` أو UID محدد مسبقًا مع قواعد أمان محكمة.
                // لأغراض هذا التعديل (إزالة شاشة الدخول)، سنفترض أن البيانات عامة أو ستتعامل
                // معها بقواعد أمان تسمح بذلك.
            }

            const layoutDocRef = doc(db, "inventory-data", userId, "layout", "main");
            layoutUnsubscribe = onSnapshot(layoutDocRef, (snapshot) => {
                if (snapshot.exists() && Object.keys(snapshot.data()).length > 0) {
                    state.warehouseConfig = snapshot.data();
                } else {
                    const defaultConfig = { A: { name: "المنطقة أ", columns: 10, shelvesPerColumn: 30 }, B: { name: "المنطقة ب", columns: 8, shelvesPerColumn: 20 } };
                    // لا تقم بـ setDoc هنا إذا كان userId عامًا، إلا إذا كنت تريد أي مستخدم
                    // أن ينشئ التكوين الافتراضي.
                    setDoc(layoutDocRef, defaultConfig);
                    state.warehouseConfig = defaultConfig;
                }
                allLocations.clear();
                for (const z in state.warehouseConfig) { for (let c = 1; c <= state.warehouseConfig[z].columns; c++) { for (let s = 1; s <= state.warehouseConfig[z].shelvesPerColumn; s++) { 
                    const locId = `${z.toUpperCase()}-${c.toString().padStart(2, '0')}-${s.toString().padStart(2, '0')}`;
                    allLocations.add(locId);
                } } }
                renderAll();
            });

            const companiesRef = collection(db, "inventory-data", userId, "companies");
            companiesUnsubscribe = onSnapshot(companiesRef, t => { state.companies = t.docs.map(o => ({ id: o.id, ...o.data() })); renderAll() }, o => console.error("Company listener failed:", o));
            
            const inventoryRef = collection(db, "inventory-data", userId, "inventory");
            inventoryUnsubscribe = onSnapshot(inventoryRef, o => { state.inventory = o.docs.map(c => ({ id: c.id, ...c.data() })); renderAll() }, o => console.error("Inventory listener failed:", o));

            const transactionsRef = collection(db, "inventory-data", userId, "transactions");
            transactionsUnsubscribe = onSnapshot(transactionsRef, t => { state.transactions = t.docs.map(c => ({ id: c.id, ...c.data() })); renderAll() }, c => console.error("Transactions listener failed:", c))

            const financialsRef = collection(db, "inventory-data", userId, "financials");
            financialsUnsubscribe = onSnapshot(financialsRef, snapshot => {
                state.financials = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, error => console.error("Financials listener failed:", error));
        }
        
        window.addCompany = async (event) => { event.preventDefault(); const t = event.target; const o = { name: t.companyName.value.trim(), contact: t.companyContact.value.trim(), address: t.companyAddress.value.trim(), phone: t.companyPhone.value.trim(), }; if (o.name && !state.companies.some(s => s.name === o.name)) try { await addDoc(collection(db, "inventory-data", userId, "companies"), o); closeModal("addCompanyModal"); t.reset(); } catch (err) { showAlert("خطأ", "لم نتمكن من إضافة الشركة."); } else showAlert("خطأ", "اسم الشركة موجود بالفعل أو غير صالح."); };
        
        window.openEditCompanyModal = (companyId) => {
            const company = state.companies.find(c => c.id === companyId);
            if (!company) {
                showAlert('خطأ', 'لم يتم العثور على العميل.');
                return;
            }
            document.getElementById('editCompanyId').value = company.id;
            document.getElementById('editCompanyName').value = company.name;
            document.getElementById('editCompanyContact').value = company.contact || '';
            document.getElementById('editCompanyAddress').value = company.address || '';
            document.getElementById('editCompanyPhone').value = company.phone || '';
            
            openModal('editCompanyModal');
        };

        const handleEditCompany = async (event) => {
            event.preventDefault();
            const form = event.target;
            const companyId = form.editCompanyId.value;
            const updatedData = {
                name: form.editCompanyName.value.trim(),
                contact: form.editCompanyContact.value.trim(),
                address: form.editCompanyAddress.value.trim(),
                phone: form.editCompanyPhone.value.trim(),
            };

            if (!updatedData.name) {
                showAlert('خطأ', 'اسم الشركة لا يمكن أن يكون فارغاً.');
                return;
            }
            
            if (state.companies.some(c => c.name === updatedData.name && c.id !== companyId)) {
                showAlert("خطأ", "اسم الشركة موجود بالفعل لعميل آخر.");
                return;
            }

            const companyDocRef = doc(db, "inventory-data", userId, "companies", companyId);

            try {
                await updateDoc(companyDocRef, updatedData);
                showAlert('نجاح', 'تم تحديث بيانات العميل بنجاح.');
                closeModal('editCompanyModal');
            } catch (err) {
                showAlert('خطأ', 'فشل تحديث بيانات العميل.');
                console.error("Failed to update company:", err);
            }
        };

        window.deleteCompany = async (e) => { if (state.inventory.some(t => t.companyId === e)) { showAlert("عملية مرفوضة", "لا يمكن حذف الشركة لأنها مرتبطة بأصناف في المخزن."); return; } showConfirmation("تأكيد الحذف", "هل أنت متأكد من حذف هذه الشركة؟", async () => { try { await deleteDoc(doc(db, "inventory-data", userId, "companies", e)) } catch (err) { showAlert("خطأ", "فشل حذف الشركة."); } }); };
        
        window.addItem = async (event) => {
             event.preventDefault();
             const form = event.target;
             const newItem = {
                 name: form.itemName.value.trim(),
                 quantity: Number(form.itemQuantity.value),
                 price: Number(form.itemPrice.value),
                 companyId: form.itemCompany.value,
                 entryDate: form.entryDate.value,
                 locationId: form.itemLocation.value.trim().toUpperCase(),
                 sku: form.itemSKU.value.trim().toUpperCase()
             };

             if (!allLocations.has(newItem.locationId)) {
                 showAlert('خطأ', 'الموقع المحدد غير صالح أو غير موجود في إعدادات المستودع.');
                 return;
             }
             const occupiedByOther = state.inventory.some(i => i.locationId === newItem.locationId && i.sku !== newItem.sku);
             if (occupiedByOther) {
                 showAlert('خطأ', `الموقع ${newItem.locationId} مشغول بصنف آخر.`);
                 return;
             }

             try {
                 const existingItemQuery = query(collection(db, "inventory-data", userId, "inventory"), where("locationId", "==", newItem.locationId), where("sku", "==", newItem.sku));
                 const querySnapshot = await getDocs(existingItemQuery);
                 if (!querySnapshot.empty) {
                     const existingDoc = querySnapshot.docs[0];
                     const newQuantity = existingDoc.data().quantity + newItem.quantity;
                     await updateDoc(doc(db, "inventory-data", userId, "inventory", existingDoc.id), { quantity: newQuantity });
                     await addDoc(collection(db, "inventory-data", userId, "transactions"), { itemId: existingDoc.id, itemSku: newItem.sku, itemName: newItem.name, type: "add", reason: "إضافة لمخزون موجود", quantity: newItem.quantity, timestamp: new Date() });
                 } else {
                     const newItemRef = await addDoc(collection(db, "inventory-data", userId, "inventory"), newItem);
                     await addDoc(collection(db, "inventory-data", userId, "transactions"), { itemId: newItemRef.id, itemSku: newItem.sku, itemName: newItem.name, type: "add", reason: "إضافة أولية", quantity: newItem.quantity, timestamp: new Date() });
                 }
                 closeModal("addItemModal");
                 form.reset();
             } catch (err) {
                 showAlert("خطأ", "فشل إضافة الصنف.");
                 console.error(err);
             }
        };

        window.openDispatchModal = e => { const t = state.inventory.find(o => o.id === e); t && showConfirmation("إخلاء الصنف بالكامل؟", `سيتم حذف الصنف ${t.name} (الكمية: ${t.quantity}) من الموقع ${t.locationId}. هل أنت متأكد؟`, async () => { try { await deleteDoc(doc(db, "inventory-data", userId, "inventory", e)); const o = { itemId: e, itemSku: t.sku, itemName: t.name, type: "dispatch", reason: "إخلاء كلي", quantity: t.quantity, timestamp: new Date }; await addDoc(collection(db, "inventory-data", userId, "transactions"), o); showAlert("نجاح", "تم إخلاء الصنف من الموقع بنجاح.") } catch (err) { showAlert("خطأ", "فشلت عملية إخلاء الصنف.") } }) };
        
        window.calculateBilling = () => {
            const companyId = document.getElementById("billing-company").value;
            const monthlyStorageRate = parseFloat(document.getElementById("storage-rate").value);
            const startDateVal = document.getElementById("billing-start-date").value;
            const endDateVal = document.getElementById("billing-end-date").value;
            const resultContainer = document.getElementById("billing-result");
            document.getElementById('report-display').classList.add('hidden'); 

            if (!companyId || !monthlyStorageRate || monthlyStorageRate <= 0 || !startDateVal || !endDateVal) {
                showAlert("بيانات ناقصة", "يرجى اختيار شركة، إدخال سعر تخزين شهري صحيح، وتحديد فترة الفاتورة بالكامل.");
                resultContainer.classList.add("hidden");
                return;
            }
            
            const dailyRate = monthlyStorageRate / 30.0;
            const billingStartDate = new Date(startDateVal);
            const billingEndDate = new Date(endDateVal);
            billingStartDate.setHours(0, 0, 0, 0);
            billingEndDate.setHours(23, 59, 59, 999); 
            
            if (billingEndDate < billingStartDate) {
                showAlert("خطأ في التواريخ", "تاريخ نهاية الفترة يجب أن يكون بعد تاريخ البداية.");
                resultContainer.classList.add("hidden");
                return;
            }

            const company = state.companies.find(c => c.id === companyId);
            const relevantInventory = state.inventory.filter(item => 
                item.companyId === companyId && new Date(item.entryDate) <= billingEndDate
            );
            
            let totalCost = 0;
            const detailsContainer = document.getElementById("billing-details");
            const uniqueLocations = [...new Set(relevantInventory.map(item => item.locationId))];

            if (uniqueLocations.length === 0) {
                detailsContainer.innerHTML = "<p>لا توجد مواقع محجوزة لهذه الشركة في الفترة المحددة.</p>";
                totalCost = 0;
            } else {
                detailsContainer.innerHTML = uniqueLocations.sort().map(locationId => {
                    const itemsInLocation = relevantInventory.filter(item => item.locationId === locationId);
                    if (itemsInLocation.length === 0) return '';
                    const earliestEntryDate = new Date(Math.min(...itemsInLocation.map(item => new Date(item.entryDate))));
                    earliestEntryDate.setHours(0,0,0,0);

                    const chargeStartDate = earliestEntryDate > billingStartDate ? earliestEntryDate : billingStartDate;
                    
                    if (chargeStartDate > billingEndDate) {
                        return ''; 
                    }
                    
                    const cleanBillingEndDate = new Date(endDateVal);
                    const storageDays = Math.max(1, Math.round((cleanBillingEndDate - chargeStartDate) / (1000 * 60 * 60 * 24)) + 1);

                    const locationCost = dailyRate * storageDays;
                    totalCost += locationCost;
                    const itemNames = itemsInLocation.map(i => `${i.name} (SKU: ${i.sku})`).join(', ');

                    return `
                        <div class="p-2 border-b flex justify-between items-start">
                            <div>
                                <p class="font-semibold">الموقع: ${locationId}</p>
                                <p class="text-sm text-slate-600">الأصناف: ${itemNames}</p>
                                <p class="text-sm text-slate-500">أيام التخزين المحتسبة: ${storageDays} (من ${chargeStartDate.toLocaleDateString("en-CA")} إلى ${cleanBillingEndDate.toLocaleDateString("en-CA")})</p>
                            </div>
                            <p class="font-semibold text-left text-slate-800 whitespace-nowrap">${locationCost.toFixed(2)} ر.س</p>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById("billing-result-company").textContent = `${company.name} (من ${new Date(startDateVal).toLocaleDateString("en-CA")} إلى ${new Date(endDateVal).toLocaleDateString("en-CA")})`;
            document.getElementById("billing-total").textContent = `${totalCost.toLocaleString("ar-SA", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ر.س`;
            resultContainer.classList.remove("hidden");
        };

        window.printInvoice = () => {
            const printableDiv = document.getElementById('printable-invoice');
            const resultDiv = document.getElementById('billing-result');

            if (!resultDiv || resultDiv.classList.contains('hidden')) {
                showAlert('لا يمكن الطباعة', 'يرجى أولاً إصدار فاتورة لعرضها.');
                return;
            }
            
            const companyId = document.getElementById("billing-company").value;
            const monthlyStorageRate = parseFloat(document.getElementById("storage-rate").value);
            const startDateVal = document.getElementById("billing-start-date").value;
            const endDateVal = document.getElementById("billing-end-date").value;
            
            if (!companyId || !monthlyStorageRate || !startDateVal || !endDateVal) return;
            
            const dailyRate = monthlyStorageRate / 30.0;
            const billingStartDate = new Date(startDateVal);
            const billingEndDate = new Date(endDateVal);
            billingStartDate.setHours(0, 0, 0, 0);
            billingEndDate.setHours(23, 59, 59, 999);
            
            const clientCompany = state.companies.find(c => c.id === companyId);
            const relevantInventory = state.inventory.filter(item => 
                item.companyId === companyId && new Date(item.entryDate) <= billingEndDate
            );
            const uniqueLocations = [...new Set(relevantInventory.map(item => item.locationId))];
            let totalCost = 0;

            const tableRows = uniqueLocations.sort().map(locationId => {
                const itemsInLocation = relevantInventory.filter(item => item.locationId === locationId);
                if (itemsInLocation.length === 0) return '';
                
                const earliestEntryDate = new Date(Math.min(...itemsInLocation.map(item => new Date(item.entryDate))));
                earliestEntryDate.setHours(0,0,0,0);
                
                const chargeStartDate = earliestEntryDate > billingStartDate ? earliestEntryDate : billingStartDate;
                
                if (chargeStartDate > billingEndDate) return '';
                
                const cleanBillingEndDate = new Date(endDateVal);
                const storageDays = Math.max(1, Math.round((cleanBillingEndDate - chargeStartDate) / (1000 * 60 * 60 * 24)) + 1);

                const locationCost = dailyRate * storageDays;
                totalCost += locationCost;
                const itemNames = itemsInLocation.map(i => i.name).join(', ');

                return `
                    <tr class="border-b">
                        <td class="p-2">${locationId}</td>
                        <td class="p-2">${itemNames}</td>
                        <td class="p-2 text-center">${storageDays}</td>
                        <td class="p-2 text-center">${dailyRate.toFixed(2)}</td>
                        <td class="p-2 text-left">${locationCost.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            const invoiceHTML = `
                <div class="p-8 bg-white text-black">
                    <header class="flex justify-between items-start pb-4 border-b">
                        <div>
                            <h1 class="text-2xl font-bold text-teal-700">شركة الحلول اللوجستية</h1>
                            <p class="text-sm">شارع الملك فهد، الرياض، المملكة العربية السعودية</p>
                            <p class="text-sm">info@logistic-solutions.sa | +966 11 123 4567</p>
                        </div>
                        <div class="text-left">
                            <h2 class="text-3xl font-bold uppercase">عرض سعر</h2>
                            <p class="text-sm">تاريخ الإصدار: ${new Date().toLocaleDateString("en-CA")}</p>
                            <p class="text-sm font-semibold">للفترة من: ${new Date(startDateVal).toLocaleDateString("en-CA")} إلى ${new Date(endDateVal).toLocaleDateString("en-CA")}</p>
                        </div>
                    </header>
                    
                    <section class="my-8">
                        <h3 class="font-bold mb-2">مقدم إلى:</h3>
                        <p>${clientCompany.name}</p>
                        <p>${clientCompany.address || 'لا يوجد عنوان'}</p>
                        <p>${clientCompany.phone || 'لا يوجد هاتف'}</p>
                    </section>

                    <section>
                        <table class="w-full text-sm">
                            <thead class="bg-slate-100">
                                <tr class="text-right">
                                    <th class="p-2 font-semibold">الموقع</th>
                                    <th class="p-2 font-semibold">تفاصيل الأصناف</th>
                                    <th class="p-2 font-semibold text-center">أيام التخزين</th>
                                    <th class="p-2 font-semibold text-center">التكلفة/يوم</th>
                                    <th class="p-2 font-semibold text-left">الإجمالي (ر.س)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </section>

                    <section class="mt-8 flex justify-end">
                        <div class="w-1/3">
                            <div class="flex justify-between border-t-2 pt-2">
                                <span class="font-bold">الإجمالي النهائي:</span>
                                <span class="font-bold text-left">${totalCost.toLocaleString("ar-SA", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ر.س</span>
                            </div>
                        </div>
                    </section>

                    <footer class="mt-16 text-xs text-center text-slate-500 border-t pt-4">
                        <p>هذا عرض سعر تقديري. الأسعار غير شاملة ضريبة القيمة المضافة.</p>
                        <p>شكرًا لتعاملكم معنا.</p>
                    </footer>
                </div>
            `;
            
            printableDiv.innerHTML = invoiceHTML;
            window.print();
            printableDiv.innerHTML = '';
        };

        window.searchBySku = () => { const skuValue = document.getElementById('sku-search-input').value.trim().toUpperCase(); if (!skuValue) return; const items = state.inventory.filter(i => i.sku === skuValue); if (items.length > 0) { const itemDetails = items.map(item => { const [zoneId, columnId, shelfId] = item.locationId.split('-'); const company = state.companies.find(c => c.id === item.companyId); return `<div class="text-right space-y-1 border-b pb-2 mb-2"> <p><strong>الموقع:</strong> ${item.locationId}</p> <p><strong>الشركة:</strong> ${company ? `${company.name}` : 'N/A'}</p> <p><strong>العدد:</strong> ${item.quantity}</p> </div>` }).join(''); showAlert(`تم العثور على SKU: ${skuValue}`, `<div class="max-h-60 overflow-y-auto">${itemDetails}</div>`); } else { showAlert('غير موجود', `لم يتم العثور على أي صنف بالـ SKU: ${skuValue}`); } };
        
        window.downloadExampleCSV = () => {
            const csvContent = "data:text/csv;charset=utf-8,"
                + "sku,name,companyName,locationId,quantity,price\n"
                + "SKU-EX-01,منتج مثال 1,الشركة المتحدة,A-01-01,50,19.99\n"
                + "SKU-EX-02,منتج مثال 2,شركة الأمواج,B-03-10,120,5.50\n";

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "مثال_استيراد_المنتجات.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const handleFileImport = e => { const t = e.target.files[0]; if (!t) return; const o = new FileReader; o.onload = c => { const a = c.target.result, n = a.split("\n").filter(l => l.trim() !== "").slice(1), s = ["sku", "name", "companyName", "locationId", "quantity", "price"]; parsedFileData = n.map(l => { const d = l.split(",").map(p => p.trim()); return s.reduce((p, i, r) => { return p[i] = d[r] || "", p }, {}) }); renderImportPreview(); ui.importPreviewContainer.style.display = "block" }; o.readAsText(t) };
        const renderImportPreview = () => { const e = document.getElementById("import-preview-body"), t = new Set(state.inventory.map(o => o.sku)), o = new Set(state.companies.map(c => c.name.toLowerCase())); let c = 0; e.innerHTML = parsedFileData.map(a => { let n = '<span class="text-green-500">✔</span>', s = []; return allLocations.has(a.locationId) || s.push("الموقع غير صالح"), o.has(a.companyName.toLowerCase()) || s.push("الشركة غير موجودة"), !a.sku || !a.name || !a.companyName || !a.locationId || !a.quantity || !a.price ? s.push("بيانات ناقصة") : isNaN(Number(a.quantity)) || isNaN(Number(a.price)) && s.push("العدد/السعر غير صحيح"), a.isValid = 0 === s.length, a.isValid ? c++ : n = `<span class="text-red-500" title="${s.join(", ")}">✖</span>`, `<tr class="${a.isValid?"bg-green-50":"bg-red-50"}"><td class="px-4 py-2">${n}</td><td class="px-4 py-2">${a.sku}</td><td class="px-4 py-2">${a.name}</td><td class="px-4 py-2">${a.companyName}</td><td class="px-4 py-2">${a.locationId}</td><td class="px-4 py-2">${a.quantity}</td><td class="px-4 py-2">${a.price}</td></tr>` }).join(""), document.getElementById("valid-rows-count").textContent = c, document.getElementById("confirm-import-button").disabled = 0 === c };
        window.confirmImport = async () => { const e = document.getElementById("delivery-date").value; if (!e) { showAlert("بيانات ناقصة", "الرجاء تحديد تاريخ الاستلام."); return } const t = parsedFileData.filter(o => o.isValid); if (0 === t.length) { showAlert("لا توجد بيانات صالحة", "لا توجد صفوف صالحة للاستيراد في الملف."); return } const o = new Map(state.companies.map(c => [c.name.toLowerCase(), c.id])), c = writeBatch(db); for (const row of t) { const existingItemQuery = query(collection(db, "inventory-data", userId, "inventory"), where("locationId", "==", row.locationId), where("sku", "==", row.sku.toUpperCase())); const querySnapshot = await getDocs(existingItemQuery); if (!querySnapshot.empty) { const existingDoc = querySnapshot.docs[0]; const newQuantity = existingDoc.data().quantity + Number(row.quantity); c.update(doc(db, "inventory-data", userId, "inventory", existingDoc.id), { quantity: newQuantity }); const transLogRef = doc(collection(db, "inventory-data", userId, "transactions")); c.set(transLogRef, { itemId: existingDoc.id, itemSku: row.sku.toUpperCase(), itemName: row.name, type: "add", reason: "استيراد ملف", quantity: Number(row.quantity), timestamp: new Date }); } else { const newItemRef = doc(collection(db, "inventory-data", userId, "inventory")); c.set(newItemRef, { name: row.name, quantity: Number(row.quantity), price: Number(row.price), companyId: o.get(row.companyName.toLowerCase()), entryDate: e, locationId: row.locationId, sku: row.sku.toUpperCase() }); const transLogRef = doc(collection(db, "inventory-data", userId, "transactions")); c.set(transLogRef, { itemId: newItemRef.id, itemSku: row.sku.toUpperCase(), itemName: row.name, type: "add", reason: "استيراد ملف", quantity: Number(row.quantity), timestamp: new Date }); } } try { await c.commit(); showAlert("نجاح", `تم استيراد ${t.length} صنف بنجاح.`); ui.importFileInput.value = ""; ui.importPreviewContainer.style.display = "none"; closeModal("importModal") } catch (e) { showAlert("خطأ", "فشلت عملية الاستيراد. يرى المحاولة مرة أخرى."); console.error("Import failed:", e) } };
        
        // --- New Add Transaction Logic ---

        function switchAddTransView(view) {
            const initialStep = document.getElementById('add-trans-initial-step');
            const existingDetails = document.getElementById('add-trans-existing-item-details');
            const newItemForm = document.getElementById('add-trans-new-item-form');

            initialStep.classList.add('hidden');
            existingDetails.classList.add('hidden');
            newItemForm.classList.add('hidden');

            if (view === 'initial') {
                initialStep.classList.remove('hidden');
            } else if (view === 'existing') {
                existingDetails.classList.remove('hidden');
            } else if (view === 'new') {
                newItemForm.classList.remove('hidden');
            }
        }

        function handleSkuSelect(event) {
            const sku = event.target.value.toUpperCase();
            const referenceItem = state.inventory.find(i => i.sku === sku);
            const errorDiv = document.getElementById('add-trans-sku-error');
            
            if (referenceItem) {
                errorDiv.classList.add('hidden');
                document.getElementById('selected-sku-name').textContent = referenceItem.name;
                document.getElementById('selected-sku-code').textContent = referenceItem.sku;
                document.getElementById('add-trans-date').valueAsDate = new Date();
                switchAddTransView('existing');
            } else {
                 errorDiv.classList.add('hidden');
            }
        }
        
        window.handleInventoryAddition = async (event) => {
            event.preventDefault();
            const form = event.target;
            
            const isNewItemMode = !document.getElementById('add-trans-new-item-form').classList.contains('hidden');
            const isExistingItemMode = !document.getElementById('add-trans-existing-item-details').classList.contains('hidden');

            try {
                if (isNewItemMode) {
                    const newItem = {
                        sku: document.getElementById('new-form-sku').value.trim().toUpperCase(),
                        name: document.getElementById('new-form-name').value.trim(),
                        companyId: document.getElementById('new-form-company').value,
                        price: Number(document.getElementById('new-form-price').value),
                        locationId: document.getElementById('new-form-location').value.trim().toUpperCase(),
                        quantity: parseInt(document.getElementById('new-form-quantity').value, 10),
                        entryDate: document.getElementById('new-form-date').value,
                        reason: document.getElementById('new-form-reason').value
                    };

                    if (!newItem.sku || !newItem.name || !newItem.companyId || !newItem.locationId || isNaN(newItem.price) || !newItem.entryDate || isNaN(newItem.quantity) || newItem.quantity <= 0) {
                        throw new Error('الرجاء ملء جميع حقول الصنف الجديد بشكل صحيح.');
                    }
                    if (state.inventory.some(i => i.sku === newItem.sku)) {
                         throw new Error(`رمز المنتج ${newItem.sku} موجود بالفعل. يرجى استخدام شاشة البحث لإضافة كمية له.`);
                    }
                     if (!allLocations.has(newItem.locationId)) {
                        throw new Error(`الموقع ${newItem.locationId} غير صالح أو غير موجود في إعدادات المستودع.`);
                    }
                    if (state.inventory.some(i => i.locationId === newItem.locationId)) {
                        throw new Error(`الموقع ${newItem.locationId} مشغول بالفعل.`);
                    }

                    const newItemRef = await addDoc(collection(db, "inventory-data", userId, "inventory"), {
                        sku: newItem.sku, name: newItem.name, companyId: newItem.companyId, price: newItem.price,
                        locationId: newItem.locationId, quantity: newItem.quantity, entryDate: newItem.entryDate
                    });
                    await addDoc(collection(db, "inventory-data", userId, "transactions"), {
                        itemId: newItemRef.id, itemSku: newItem.sku, itemName: newItem.name, type: 'add',
                        reason: newItem.reason, quantity: newItem.quantity, timestamp: new Date()
                    });
                     showAlert('نجاح', 'تم إضافة الصنف الجديد وتسجيل الحركة بنجاح.');

                } else if (isExistingItemMode) {
                    const sku = document.getElementById('selected-sku-code').textContent;
                    const referenceItem = state.inventory.find(i => i.sku === sku);
                    if (!referenceItem) throw new Error("لم يتم العثور على الصنف المرجعي.");

                    const locationId = document.getElementById('add-trans-location').value.trim().toUpperCase();
                    const quantity = parseInt(document.getElementById('add-trans-quantity').value, 10);
                    const entryDate = document.getElementById('add-trans-date').value;
                    const reason = document.getElementById('add-trans-reason').value;

                    if (!locationId || !entryDate || isNaN(quantity) || quantity <= 0) {
                        throw new Error("الرجاء ملء جميع حقول الإضافة بشكل صحيح.");
                    }
                    if (!allLocations.has(locationId)) {
                        throw new Error(`الموقع ${locationId} غير صالح أو غير موجود في إعدادات المستودع.`);
                    }

                    const existingRecord = state.inventory.find(i => i.sku === sku && i.locationId === locationId);
                    
                    if (existingRecord) {
                        const itemDocRef = doc(db, "inventory-data", userId, "inventory", existingRecord.id);
                        const newQuantity = existingRecord.quantity + quantity;
                        await updateDoc(itemDocRef, { quantity: newQuantity });
                        await addDoc(collection(db, "inventory-data", userId, "transactions"), {
                            itemId: existingRecord.id, itemSku: sku, itemName: referenceItem.name, type: 'add',
                            reason: reason, quantity: quantity, timestamp: new Date()
                        });
                        showAlert('نجاح', `تمت إضافة الكمية إلى الموقع ${locationId} بنجاح.`);

                    } else {
                        const locationOccupant = state.inventory.find(i => i.locationId === locationId);
                        if (locationOccupant) {
                            throw new Error(`الموقع ${locationId} مشغول بصنف آخر (SKU: ${locationOccupant.sku}).`);
                        }
                        const newItemInNewLocation = {
                            sku: referenceItem.sku, name: referenceItem.name, companyId: referenceItem.companyId,
                            price: referenceItem.price, locationId: locationId, quantity: quantity, entryDate: entryDate
                        };
                        const newItemRef = await addDoc(collection(db, "inventory-data", userId, "inventory"), newItemInNewLocation);
                        await addDoc(collection(db, "inventory-data", userId, "transactions"), {
                            itemId: newItemRef.id, itemSku: sku, itemName: referenceItem.name, type: 'add',
                            reason: reason, quantity: quantity, timestamp: new Date()
                        });
                        showAlert('نجاح', `تم تخزين الصنف في الموقع الجديد ${locationId} بنجاح.`);
                    }
                } else {
                    const skuInput = document.getElementById('add-trans-sku-select').value.toUpperCase();
                    if(skuInput && !state.inventory.some(i => i.sku === skuInput)) {
                        document.getElementById('add-trans-sku-error').classList.remove('hidden');
                    } else {
                        showAlert('إجراء غير مكتمل', 'الرجاء اختيار صنف موجود أو إضافة صنف جديد أولاً.');
                    }
                    return; 
                }

                closeModal('addTransactionModal');

            } catch (err) {
                 showAlert('فشل العملية', err.message);
                 console.error("Inventory Addition Failed: ", err);
            }
        };


        window.handleInventoryDispatch = async (event) => {
            event.preventDefault();
            const form = event.target;
            const quantity = parseInt(form['dispatch-trans-quantity'].value, 10);
            const reason = form['dispatch-trans-reason'].value;
            const selectedItemRadio = form.querySelector('input[name="selected-item-dispatch"]:checked');
            
            if (isNaN(quantity) || quantity <= 0) {
                showAlert('بيانات ناقصة', 'الرجاء إدخال كمية رقمية صحيحة أكبر من صفر.');
                return;
            }

            if (!selectedItemRadio) {
                showAlert('خطأ', 'الرجاء اختيار صنف من قائمة البحث لصرف الكمية منه.');
                return;
            }

            const itemId = selectedItemRadio.value;
            const itemDocRef = doc(db, "inventory-data", userId, "inventory", itemId);

            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemDocRef);
                    if (!itemDoc.exists()) {
                        throw "لم يتم العثور على الصنف!";
                    }
                    const oldQuantity = itemDoc.data().quantity;
                    if (quantity > oldQuantity) {
                        throw `الكمية المطلوبة للصرف (${quantity}) أكبر من المتوفر (${oldQuantity}).`;
                    }
                    const newQuantity = oldQuantity - quantity;

                    if (newQuantity > 0) {
                        transaction.update(itemDocRef, { quantity: newQuantity });
                    } else {
                        transaction.delete(itemDocRef);
                    }
                    
                    const transLogRef = doc(collection(db, "inventory-data", userId, "transactions"));
                    transaction.set(transLogRef, {
                        itemId: itemId, itemSku: itemDoc.data().sku, itemName: itemDoc.data().name,
                        type: 'dispatch', reason: reason, quantity: quantity, timestamp: new Date()
                    });
                });
                showAlert('نجاح', 'تم تسجيل الصرف بنجاح.');
                closeModal('dispatchTransactionModal');
            } catch (err) {
                showAlert('فشل العملية', `فشلت الحركة: ${err.toString()}`);
                console.error("Dispatch transaction failed: ", err);
            }
        };
        
        window.addFinancialTransaction = async (event, type) => {
            event.preventDefault();
            const form = event.target;
            const transaction = {
                type: type,
                date: form.querySelector('input[type="date"]').value,
                description: form.querySelector('input[type="text"]').value.trim(),
                category: form.querySelector('select').value,
                amount: Number(form.querySelector('input[type="number"]').value),
                createdAt: new Date()
            };

            if (!transaction.date || !transaction.description || !transaction.amount > 0) {
                showAlert('بيانات ناقصة', 'الرجاء ملء جميع الحقول بشكل صحيح.');
                return;
            }

            try {
                await addDoc(collection(db, "inventory-data", userId, "financials"), transaction);
                showAlert('نجاح', `تمت إضافة ${type === 'revenue' ? 'الإيراد' : 'المصروف'} بنجاح.`);
                closeModal(type === 'revenue' ? 'addRevenueModal' : 'addExpenseModal');
            } catch (error) {
                console.error("Error adding financial transaction: ", error);
                showAlert('خطأ', 'فشلت عملية إضافة المعاملة المالية.');
            }
        };

        window.deleteFinancialTransaction = async (docId) => {
            showConfirmation('تأكيد الحذف', 'هل أنت متأكد من حذف هذه المعاملة المالية؟ لا يمكن التراجع عن هذا الإجراء.', async () => {
                try {
                    await deleteDoc(doc(db, "inventory-data", userId, "financials", docId));
                    showAlert('نجاح', 'تم حذف المعاملة المالية.');
                } catch (error) {
                    console.error("Error deleting financial transaction: ", error);
                    showAlert('خطأ', 'فشلت عملية الحذف.');
                }
            });
        };

        window.handleZoneSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const zoneId = form['zone-id'].value.trim().toUpperCase();
            const editId = form['zone-edit-id'].value;

            if (!zoneId.match(/^[A-Z]$/)) { showAlert('خطأ', 'معرف المنطقة يجب أن يكون حرفاً إنجليزياً واحداً.'); return; }
            if (!editId && state.warehouseConfig[zoneId]) { showAlert('خطأ', 'معرف المنطقة هذا مستخدم بالفعل.'); return; }

            const zoneData = {
                name: form['zone-name'].value.trim(),
                columns: Number(form['zone-columns'].value),
                shelvesPerColumn: Number(form['zone-shelves'].value),
            };

            const newConfig = { ...state.warehouseConfig };
            newConfig[zoneId] = zoneData;
            
            try {
                await setDoc(doc(db, "inventory-data", userId, "layout", "main"), newConfig);
                showAlert('نجاح', `تم ${editId ? 'تعديل' : 'إضافة'} المنطقة بنجاح.`);
                closeModal('addZoneModal');
            } catch(e) {
                console.error("Error saving zone:", e);
                showAlert('خطأ', 'فشل حفظ إعدادات المنطقة.');
            }
        };
        window.deleteZone = async (zoneId) => {
            const isUsed = state.inventory.some(item => item.locationId.startsWith(zoneId));
            if (isUsed) { showAlert('عملية مرفوضة', 'لا يمكن حذف المنطقة لأنها تحتوي على أصناف مخزنة.'); return; }

            showConfirmation('تأكيد الحذف', `هل أنت متأكد من حذف المنطقة ${zoneId} وكل إعداداتها؟`, async () => {
                const newConfig = { ...state.warehouseConfig };
                delete newConfig[zoneId];
                try {
                    await setDoc(doc(db, "inventory-data", userId, "layout", "main"), newConfig);
                    showAlert('نجاح', 'تم حذف المنطقة بنجاح.');
                } catch(e) {
                    console.error("Error deleting zone:", e);
                    showAlert('خطأ', 'فشل حذف المنطقة.');
                }
            });
        };

        window.generateInventoryReport = () => {
            if (state.inventory.length === 0) {
                showAlert('لا توجد بيانات', 'لا يوجد مخزون لعرضه في التقرير.');
                return;
            }
            const companyMap = new Map(state.companies.map(c => [c.id, c.name]));
            const reportContent = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">الموقع</th><th scope="col" class="px-6 py-3">SKU</th>
                            <th scope="col" class="px-6 py-3">الصنف</th><th scope="col" class="px-6 py-3">الشركة</th>
                            <th scope="col" class="px-6 py-3">العدد</th><th scope="col" class="px-6 py-3">تاريخ الإدخال</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${state.inventory.sort((a, b) => a.locationId.localeCompare(b.locationId)).map(item => `
                            <tr class="bg-white border-b">
                                <td class="px-6 py-4 font-bold">${item.locationId}</td><td class="px-6 py-4">${item.sku}</td>
                                <td class="px-6 py-4">${item.name}</td><td class="px-6 py-4">${companyMap.get(item.companyId) || 'N/A'}</td>
                                <td class="px-6 py-4">${item.quantity}</td><td class="px-6 py-4">${item.entryDate}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            document.getElementById('report-display-title').textContent = 'تقرير المخزون الحالي';
            document.getElementById('report-display-content').innerHTML = reportContent;
            document.getElementById('report-display').classList.remove('hidden');
            document.getElementById('billing-result').classList.add('hidden');
        };

        window.generateTransactionsReport = () => {
            const startDateInput = document.getElementById('report-start-date'), endDateInput = document.getElementById('report-end-date');
            if (!startDateInput.value || !endDateInput.value) { showAlert('بيانات ناقصة', 'يرجى تحديد تاريخ البدء والانتهاء للتقرير.'); return; }
            const startDate = new Date(startDateInput.value); startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateInput.value); endDate.setHours(23, 59, 59, 999);
            const filteredTransactions = state.transactions.filter(t => { const transDate = t.timestamp.toDate(); return transDate >= startDate && transDate <= endDate; });
            if (filteredTransactions.length === 0) { showAlert('لا توجد بيانات', 'لا توجد حركات في الفترة المحددة.'); return; }
            const reportContent = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="px-4 py-2">التاريخ والوقت</th><th class="px-4 py-2">نوع الحركة</th>
                            <th class="px-4 py-2">السبب</th><th class="px-4 py-2">SKU</th>
                            <th class="px-4 py-2">الصنف</th><th class="px-4 py-2">الكمية</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTransactions.sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate()).map(t => {
                            const isAdd = t.type === 'add';
                            return `
                            <tr class="bg-white border-b">
                                <td class="px-4 py-2">${t.timestamp.toDate().toLocaleString('en-CA')}</td>
                                <td class="px-4 py-2 font-semibold ${isAdd ? 'text-green-600' : 'text-red-600'}">${isAdd ? 'إضافة' : 'صرف'}</td>
                                <td class="px-4 py-2">${t.reason}</td><td class="px-4 py-2">${t.itemSku}</td>
                                <td class="px-4 py-2">${t.itemName}</td><td class="px-4 py-2">${t.quantity}</td>
                            </tr>`}).join('')}
                    </tbody>
                </table>`;
            document.getElementById('report-display-title').textContent = `تقرير الحركات من ${startDate.toLocaleDateString('en-CA')} إلى ${endDate.toLocaleDateString('en-CA')}`;
            document.getElementById('report-display-content').innerHTML = reportContent;
            document.getElementById('report-display').classList.remove('hidden');
            document.getElementById('billing-result').classList.add('hidden');
        };

        window.printGeneratedReport = () => {
            const reportTitle = document.getElementById('report-display-title').textContent;
            const reportHTML = document.getElementById('report-display-content').innerHTML;
            const printableDiv = document.getElementById('printable-invoice');
            printableDiv.innerHTML = `<div class="p-8 bg-white text-black" style="direction: rtl; font-family: 'Cairo', sans-serif;"><h1 class="text-2xl font-bold mb-4 text-center">${reportTitle}</h1><p class="text-center text-sm mb-6">تاريخ الطباعة: ${new Date().toLocaleString('en-CA')}</p>${reportHTML}</div>`;
            window.print();
            printableDiv.innerHTML = '';
        };

        // --- Attach Listeners ---
        document.getElementById('add-trans-sku-select').addEventListener('input', handleSkuSelect);
        document.getElementById('add-new-item-btn').addEventListener('click', () => switchAddTransView('new'));
        document.getElementById('back-to-search-btn').addEventListener('click', () => switchAddTransView('initial'));
        document.getElementById('change-sku-btn').addEventListener('click', () => switchAddTransView('initial'));

        document.getElementById('dispatch-trans-sku-search').addEventListener('input', (e) => {
            const sku = e.target.value.toUpperCase();
            const resultsContainer = document.getElementById('dispatch-sku-search-results');
            resultsContainer.innerHTML = '';
            if (!sku) return;

            const matchingItems = state.inventory.filter(item => item.sku === sku);
            if(matchingItems.length > 0) {
                 resultsContainer.innerHTML = matchingItems.map(item => `
                    <label class="flex items-center p-2 border rounded-lg hover:bg-slate-100 cursor-pointer mb-1">
                        <input type="radio" name="selected-item-dispatch" value="${item.id}" class="ml-3">
                        <span><strong>${item.name}</strong> في <strong>${item.locationId}</strong> (الكمية الحالية: ${item.quantity})</span>
                    </label>`).join('');
            } else {
                 resultsContainer.innerHTML = `<p class="text-red-500 p-2">لا يوجد صنف بهذا الـ SKU.</p>`;
            }
        });
        
        document.getElementById('addInventoryForm').addEventListener('submit', handleInventoryAddition);
        document.getElementById('dispatchInventoryForm').addEventListener('submit', handleInventoryDispatch);
        document.getElementById('addCompanyForm').addEventListener('submit', addCompany);
        document.getElementById('editCompanyForm').addEventListener('submit', handleEditCompany);
        document.getElementById('addItemForm').addEventListener('submit', addItem);
        document.getElementById('addZoneForm').addEventListener('submit', handleZoneSubmit);
        document.getElementById('addRevenueForm').addEventListener('submit', (e) => addFinancialTransaction(e, 'revenue'));
        document.getElementById('addExpenseForm').addEventListener('submit', (e) => addFinancialTransaction(e, 'expense'));

        ui.searchInput.addEventListener('input', renderInventoryPage);
        ui.importFileInput.addEventListener('change', handleFileImport);
        
        initializeFirebase();
    </script>
</body>
</html>
